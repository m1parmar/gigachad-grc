import{aK as U,r as y,u as G,b as v,c as j,j as e,M as z,aL as H,aM as V,S as Y,ay as W,aa as O,v as J,L as X,am as Z}from"./vendor-CWk44mA8.js";import{B as w,V as p,U as ee,m as te}from"./index-CiJwl-Bo.js";import{M as se}from"./Modal-BXiMOSLX.js";import{E as ae}from"./EmptyState-DqJSE5Oy.js";import{a as le}from"./Skeleton-DVOICtGK.js";import{u as re}from"./useToast-oJzujiun.js";import{u as ie,B as ne,a as q}from"./BulkActions-DgJpXIcY.js";import"./vendor-http-B9ygI19o.js";import"./vendor-date-CWdg4M78.js";const N={critical:{label:"Critical",color:"text-red-400",bgColor:"bg-red-500/20"},high:{label:"High",color:"text-orange-400",bgColor:"bg-orange-500/20"},medium:{label:"Medium",color:"text-yellow-400",bgColor:"bg-yellow-500/20"},low:{label:"Low",color:"text-blue-400",bgColor:"bg-blue-500/20"},observation:{label:"Observation",color:"text-surface-400",bgColor:"bg-surface-500/20"}},P={open:{label:"Open",color:"text-red-400",icon:J},acknowledged:{label:"Acknowledged",color:"text-yellow-400",icon:O},remediation_planned:{label:"Planned",color:"text-blue-400",icon:O},remediation_in_progress:{label:"In Progress",color:"text-cyan-400",icon:W},resolved:{label:"Resolved",color:"text-green-400",icon:Y},accepted_risk:{label:"Risk Accepted",color:"text-purple-400",icon:V}},_=[{value:"control_deficiency",label:"Control Deficiency"},{value:"documentation_gap",label:"Documentation Gap"},{value:"process_issue",label:"Process Issue"},{value:"compliance_gap",label:"Compliance Gap"}],F=[{value:"open",label:"Open"},{value:"acknowledged",label:"Acknowledged"},{value:"remediation_planned",label:"Remediation Planned"},{value:"remediation_in_progress",label:"In Progress"},{value:"resolved",label:"Resolved"},{value:"accepted_risk",label:"Risk Accepted"}];function ge(){const[l,b]=U(),[C,u]=y.useState(!1),[d,m]=y.useState(null),[a,i]=y.useState(!1),o=G(),s=re(),n={auditId:l.get("auditId")||"",status:l.get("status")||"",severity:l.get("severity")||"",category:l.get("category")||""},f=(t,r)=>{r?l.set(t,r):l.delete(t),b(l)},{data:T,isLoading:M}=v({queryKey:["audit-findings",n],queryFn:()=>p.list(n.auditId||n.status||n.severity||n.category?n:void 0).then(t=>t.data)}),{data:$}=v({queryKey:["audit-findings-stats"],queryFn:()=>p.getStats().then(t=>t.data)}),{data:k}=v({queryKey:["audits"],queryFn:()=>ee.list().then(t=>t.data)}),{data:E}=v({queryKey:["users"],queryFn:()=>te.list().then(t=>t.data?.data||[])}),g=T||[],x=$,c=ie(g),D=j({mutationFn:t=>p.create(t),onSuccess:()=>{o.invalidateQueries({queryKey:["audit-findings"]}),o.invalidateQueries({queryKey:["audit-findings-stats"]}),u(!1),s.success("Finding created successfully")},onError:t=>{s.error(t.message||"Failed to create finding")}}),I=j({mutationFn:({id:t,data:r})=>p.update(t,r),onSuccess:()=>{o.invalidateQueries({queryKey:["audit-findings"]}),o.invalidateQueries({queryKey:["audit-findings-stats"]}),m(null),s.success("Finding updated successfully")},onError:t=>{s.error(t.message||"Failed to update finding")}}),R=j({mutationFn:t=>p.delete(t),onSuccess:()=>{o.invalidateQueries({queryKey:["audit-findings"]}),o.invalidateQueries({queryKey:["audit-findings-stats"]}),s.success("Finding deleted successfully")},onError:t=>{s.error(t.message||"Failed to delete finding")}}),K=j({mutationFn:({ids:t,status:r})=>p.bulkUpdateStatus(t,r),onSuccess:(t,{ids:r})=>{o.invalidateQueries({queryKey:["audit-findings"]}),o.invalidateQueries({queryKey:["audit-findings-stats"]}),s.success(`Updated ${r.length} findings`),c.clearSelection()},onError:t=>{s.error(t.message||"Failed to update findings")}}),Q=async()=>{const t=c.selectedItems.length;try{await Promise.all(c.selectedItems.map(r=>R.mutateAsync(r.id))),s.success(`Deleted ${t} findings`),c.clearSelection()}catch{s.error("Failed to delete some findings")}},B=t=>{const r=c.selectedItems.map(h=>h.id);K.mutate({ids:r,status:t})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold text-white",children:"Audit Findings"}),e.jsx("p",{className:"text-surface-400 mt-1",children:"Track and remediate audit findings and observations"})]}),e.jsx(w,{leftIcon:e.jsx(z,{className:"w-5 h-5"}),onClick:()=>u(!0),children:"New Finding"})]}),x&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Total Findings"}),e.jsx("p",{className:"text-2xl font-bold text-white mt-1",children:x.total})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Overdue"}),e.jsx("p",{className:"text-2xl font-bold text-red-400 mt-1",children:x.overdue})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Critical/High"}),e.jsx("p",{className:"text-2xl font-bold text-orange-400 mt-1",children:(x.bySeverity.find(t=>t.severity==="critical")?.count||0)+(x.bySeverity.find(t=>t.severity==="high")?.count||0)})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Open"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-400 mt-1",children:x.byStatus.find(t=>t.status==="open")?.count||0})]})]}),c.selectedItems.length>0&&e.jsx(ne,{selectedCount:c.selectedItems.length,totalCount:g.length,onClear:c.clearSelection,actions:[{id:"delete",label:"Delete",variant:"danger",requiresConfirmation:!0,confirmMessage:"Are you sure you want to delete these findings?"},...F.map(t=>({id:`status-${t.value}`,label:`Set ${t.label}`,variant:"secondary"}))],onAction:t=>{if(t==="delete")Q();else if(t.startsWith("status-")){const r=t.replace("status-","");B(r)}}}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(w,{variant:"secondary",size:"sm",leftIcon:e.jsx(H,{className:"w-4 h-4"}),onClick:()=>i(!a),children:"Filters"}),Object.values(n).some(Boolean)&&e.jsx("button",{onClick:()=>b(new URLSearchParams),className:"text-sm text-brand-400 hover:text-brand-300",children:"Clear filters"})]}),a&&e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Audit"}),e.jsxs("select",{value:n.auditId,onChange:t=>f("auditId",t.target.value),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"All Audits"}),k?.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Status"}),e.jsxs("select",{value:n.status,onChange:t=>f("status",t.target.value),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"All Statuses"}),F.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Severity"}),e.jsxs("select",{value:n.severity,onChange:t=>f("severity",t.target.value),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"All Severities"}),Object.entries(N).map(([t,{label:r}])=>e.jsx("option",{value:t,children:r},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Category"}),e.jsxs("select",{value:n.category,onChange:t=>f("category",t.target.value),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"All Categories"}),_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]})]}),M?e.jsx(le,{rows:8,columns:6}):g?.length?e.jsx("div",{className:"bg-surface-800 rounded-lg border border-surface-700 overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-surface-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-10 px-4 py-3",children:e.jsx(q,{checked:c.isAllSelected,indeterminate:c.isPartialSelected,onChange:c.toggleAll})}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Finding"}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Audit"}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Severity"}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Status"}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Target Date"}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-medium text-surface-300",children:"Owner"}),e.jsx("th",{className:"w-10"})]})}),e.jsx("tbody",{className:"divide-y divide-surface-700",children:g.map(t=>{const r=N[t.severity]||N.medium,h=P[t.status]||P.open,L=h.icon,A=t.targetDate&&new Date(t.targetDate)<new Date&&!["resolved","accepted_risk"].includes(t.status);return e.jsxs("tr",{className:"hover:bg-surface-700/50 cursor-pointer",onClick:()=>m(t),children:[e.jsx("td",{className:"px-4 py-3",onClick:S=>S.stopPropagation(),children:e.jsx(q,{checked:c.isSelected(t.id),onChange:()=>c.toggle(t.id)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-surface-400 font-mono text-sm",children:t.findingNumber}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white font-medium",children:t.title}),e.jsx("p",{className:"text-surface-400 text-sm truncate max-w-md",children:t.description})]})]})}),e.jsx("td",{className:"px-4 py-3",children:t.audit?e.jsx(X,{to:`/audits/${t.audit.id}`,onClick:S=>S.stopPropagation(),className:"text-brand-400 hover:text-brand-300 text-sm",children:t.audit.name}):e.jsx("span",{className:"text-surface-500",children:"—"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.bgColor} ${r.color}`,children:r.label})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:`flex items-center gap-1.5 ${h.color}`,children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:h.label})]})}),e.jsx("td",{className:"px-4 py-3",children:t.targetDate?e.jsxs("span",{className:A?"text-red-400":"text-surface-300",children:[new Date(t.targetDate).toLocaleDateString(),A&&e.jsx("span",{className:"ml-1 text-xs",children:"(Overdue)"})]}):e.jsx("span",{className:"text-surface-500",children:"—"})}),e.jsx("td",{className:"px-4 py-3 text-surface-300 text-sm",children:t.remediationOwner||"—"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(Z,{className:"w-5 h-5 text-surface-500"})})]},t.id)})})]})}):e.jsx(ae,{variant:"warning",title:"No findings yet",description:"Audit findings will appear here as audits are conducted. Track open findings, assign remediation tasks, and monitor progress.",action:{label:"Create Finding",onClick:()=>u(!0)}}),e.jsx(se,{isOpen:C||!!d,onClose:()=>{u(!1),m(null)},title:d?"Edit Finding":"Create Finding",size:"lg",children:e.jsx(ce,{finding:d,audits:k,users:E,onSubmit:t=>{d?I.mutate({id:d.id,data:t}):D.mutate(t)},onDelete:d?()=>{confirm("Are you sure you want to delete this finding?")&&(R.mutate(d.id),m(null))}:void 0,isLoading:D.isPending||I.isPending})})]})}function ce({finding:l,audits:b,users:C,onSubmit:u,onDelete:d,isLoading:m}){const[a,i]=y.useState({auditId:l?.auditId||"",title:l?.title||"",description:l?.description||"",category:l?.category||"control_deficiency",severity:l?.severity||"medium",status:l?.status||"open",controlId:l?.controlId||"",requirementRef:l?.requirementRef||"",remediationPlan:l?.remediationPlan||"",remediationOwner:l?.remediationOwner||"",targetDate:l?.targetDate?l.targetDate.split("T")[0]:"",rootCause:l?.rootCause||"",impact:l?.impact||"",recommendation:l?.recommendation||"",managementResponse:l?.managementResponse||""}),o=s=>{s.preventDefault();const n=localStorage.getItem("organizationId")||"";u({...a,organizationId:n,targetDate:a.targetDate||void 0})};return e.jsxs("form",{onSubmit:o,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:["Audit ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsxs("select",{value:a.auditId,onChange:s=>i({...a,auditId:s.target.value}),required:!0,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"Select Audit"}),b?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:["Title ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:a.title,onChange:s=>i({...a,title:s.target.value}),required:!0,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Finding title"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:["Description ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:a.description,onChange:s=>i({...a,description:s.target.value}),required:!0,rows:3,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Detailed description of the finding"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Category"}),e.jsx("select",{value:a.category,onChange:s=>i({...a,category:s.target.value}),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:_.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Severity"}),e.jsx("select",{value:a.severity,onChange:s=>i({...a,severity:s.target.value}),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:Object.entries(N).map(([s,{label:n}])=>e.jsx("option",{value:s,children:n},s))})]}),l&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Status"}),e.jsx("select",{value:a.status,onChange:s=>i({...a,status:s.target.value}),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:F.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Target Date"}),e.jsx("input",{type:"date",value:a.targetDate,onChange:s=>i({...a,targetDate:s.target.value}),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white"})]}),e.jsxs("div",{className:l?"":"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Remediation Owner"}),e.jsxs("select",{value:a.remediationOwner,onChange:s=>i({...a,remediationOwner:s.target.value}),className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",children:[e.jsx("option",{value:"",children:"Select Owner"}),C?.map(s=>e.jsxs("option",{value:s.id,children:[s.firstName," ",s.lastName," (",s.email,")"]},s.id))]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Root Cause"}),e.jsx("textarea",{value:a.rootCause,onChange:s=>i({...a,rootCause:s.target.value}),rows:2,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Root cause analysis"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Impact"}),e.jsx("textarea",{value:a.impact,onChange:s=>i({...a,impact:s.target.value}),rows:2,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Business impact of this finding"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Recommendation"}),e.jsx("textarea",{value:a.recommendation,onChange:s=>i({...a,recommendation:s.target.value}),rows:2,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Recommended remediation steps"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Remediation Plan"}),e.jsx("textarea",{value:a.remediationPlan,onChange:s=>i({...a,remediationPlan:s.target.value}),rows:2,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Detailed remediation plan"})]}),l&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-300 mb-1",children:"Management Response"}),e.jsx("textarea",{value:a.managementResponse,onChange:s=>i({...a,managementResponse:s.target.value}),rows:2,className:"w-full bg-surface-700 border border-surface-600 rounded-md px-3 py-2 text-white",placeholder:"Management's response to this finding"})]})]}),e.jsxs("div",{className:"flex justify-between pt-4 border-t border-surface-700",children:[d&&e.jsx(w,{type:"button",variant:"danger",onClick:d,children:"Delete Finding"}),e.jsx("div",{className:"flex gap-3 ml-auto",children:e.jsx(w,{type:"submit",isLoading:m,children:l?"Update Finding":"Create Finding"})})]})]})}export{ge as default};
