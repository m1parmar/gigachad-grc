import{u as ie,r,b as L,c as q,j as e,m as U,B as S,S as me,aM as he,ay as O,aD as x,M as oe,g as pe,aa as Q,w as te,aP as Ee,aQ as fe,h as je,aR as Te,V as Pe,aS as qe,k as Re,W as Ae,L as G,aO as Me,y as ne,a4 as De,G as Ie}from"./vendor-CWk44mA8.js";import{i as D,j as Le,b as $e,B as R,e as ae,k as ue,l as Ke,p as le,m as Qe}from"./index-CiJwl-Bo.js";import{C as Ue,T as Oe}from"./TasksPanel-lJoOjrDO.js";import{f as He,a as xe}from"./vendor-date-CWdg4M78.js";import{E as Be}from"./EntityAuditHistory-C0v1gX0U.js";import{b as _e,c as K}from"./Skeleton-DVOICtGK.js";import"./vendor-http-B9ygI19o.js";const ze=["GET","POST","PUT","DELETE","PATCH"],Ve=[{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"monthly",label:"Monthly"}];function Ge({controlId:t,implementationId:u,collector:n,onClose:v}){const c=ie(),N=!!n,[m,F]=r.useState(n?.name||""),[k,b]=r.useState(n?.description||""),[g,f]=r.useState(n?.mode||"standalone"),[y,l]=r.useState(n?.integrationId||""),[o,j]=r.useState(n?.baseUrl||""),[w,d]=r.useState(n?.endpoint||""),[i,J]=r.useState(n?.method||"GET"),[H,W]=r.useState(n?.headers?Object.entries(n.headers).map(([a,C])=>`${a}: ${C}`).join(`
`):""),[B,_]=r.useState(n?.queryParams?Object.entries(n.queryParams).map(([a,C])=>`${a}=${C}`).join(`
`):""),[I,z]=r.useState(n?.body?JSON.stringify(n.body,null,2):""),[E,Y]=r.useState(n?.authType||""),[h,p]=r.useState({keyName:n?.authConfig?.keyName||"",keyValue:n?.authConfig?.keyValue||"",location:n?.authConfig?.location||"header",tokenUrl:n?.authConfig?.tokenUrl||"",clientId:n?.authConfig?.clientId||"",clientSecret:n?.authConfig?.clientSecret||"",scope:n?.authConfig?.scope||"",token:n?.authConfig?.token||"",username:n?.authConfig?.username||"",password:n?.authConfig?.password||""}),[s,ge]=r.useState(n?.evidenceTitle||""),[re,ve]=r.useState(n?.evidenceType||"automated"),[T,X]=r.useState({titleField:n?.responseMapping?.titleField||"",descriptionField:n?.responseMapping?.descriptionField||"",dataField:n?.responseMapping?.dataField||""}),[V,Ne]=r.useState(n?.scheduleEnabled||!1),[ce,be]=r.useState(n?.scheduleFrequency||"daily"),[A,de]=r.useState(null),{data:ye}=L({queryKey:["integrations"],queryFn:()=>Le.list().then(a=>a.data)}),we=ye||[],Ce=a=>{const C={};return a.split(`
`).forEach(P=>{const M=P.indexOf(":");if(M>0){const $=P.substring(0,M).trim(),se=P.substring(M+1).trim();$&&(C[$]=se)}}),C},Se=a=>{const C={};return a.split(`
`).forEach(P=>{const M=P.indexOf("=");if(M>0){const $=P.substring(0,M).trim(),se=P.substring(M+1).trim();$&&(C[$]=se)}}),C},ke=()=>{const a={name:m,description:k,mode:g,endpoint:w,method:i,evidenceTitle:s,evidenceType:re,scheduleEnabled:V,scheduleFrequency:V?ce:void 0,responseMapping:T.titleField||T.descriptionField||T.dataField?T:void 0};g==="integration"?a.integrationId=y:(a.baseUrl=o,E&&(a.authType=E,a.authConfig=h));const C=Ce(H);Object.keys(C).length>0&&(a.headers=C);const P=Se(B);if(Object.keys(P).length>0&&(a.queryParams=P),["POST","PUT","PATCH"].includes(i)&&I)try{a.body=JSON.parse(I)}catch{}return a},Z=q({mutationFn:a=>N?D.update(t,u,n.id,a):D.create(t,u,a),onSuccess:()=>{c.invalidateQueries({queryKey:["collectors",t,u]}),x.success(N?"Collector updated":"Collector created"),v()},onError:a=>{x.error(a.response?.data?.message||"Failed to save collector")}}),ee=q({mutationFn:()=>{if(N)return D.test(t,u,n.id);throw new Error("Save the collector first before testing")},onSuccess:a=>{de(a.data),a.data.success?x.success("Connection test successful"):x.error("Connection test failed")},onError:a=>{de({success:!1,message:a.message}),x.error(a.message||"Test failed")}}),Fe=()=>{if(!m.trim()){x.error("Name is required");return}Z.mutate(ke())};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/70",onClick:v}),e.jsxs("div",{className:"relative bg-surface-900 rounded-xl w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-surface-700",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:N?"Edit Evidence Collector":"Create Evidence Collector"}),e.jsx("p",{className:"text-sm text-surface-400",children:"Configure an API endpoint to automatically collect evidence"})]}),e.jsx("button",{onClick:v,className:"p-2 text-surface-400 hover:text-surface-200",children:e.jsx(U,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Name *"}),e.jsx("input",{type:"text",value:m,onChange:a=>F(a.target.value),placeholder:"MFA Status Collector",className:"input mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Evidence Type"}),e.jsxs("select",{value:re,onChange:a=>ve(a.target.value),className:"input mt-1",children:[e.jsx("option",{value:"automated",children:"Automated"}),e.jsx("option",{value:"config",children:"Configuration"}),e.jsx("option",{value:"log",children:"Log"}),e.jsx("option",{value:"report",children:"Report"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description"}),e.jsx("textarea",{value:k,onChange:a=>b(a.target.value),placeholder:"What this collector does...",rows:2,className:"input mt-1"})]}),e.jsxs("div",{className:"border border-surface-700 rounded-lg p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-200 mb-3",children:"Configuration Mode"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"mode",checked:g==="integration",onChange:()=>f("integration"),className:"text-brand-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-surface-300",children:"Use Existing Integration"}),e.jsx("p",{className:"text-xs text-surface-500",children:"Leverage auth from a configured integration"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:"mode",checked:g==="standalone",onChange:()=>f("standalone"),className:"text-brand-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-surface-300",children:"Standalone API"}),e.jsx("p",{className:"text-xs text-surface-500",children:"Configure a completely separate API endpoint"})]})]})]}),g==="integration"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"label",children:"Integration"}),e.jsxs("select",{value:y,onChange:a=>l(a.target.value),className:"input mt-1",children:[e.jsx("option",{value:"",children:"Select an integration..."}),we.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.type,")"]},a.id))]})]}),g==="standalone"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"label",children:"Base URL"}),e.jsx("input",{type:"text",value:o,onChange:a=>j(a.target.value),placeholder:"https://api.example.com",className:"input mt-1"})]})]}),e.jsxs("div",{className:"border border-surface-700 rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-200",children:"Endpoint Configuration"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"w-32",children:[e.jsx("label",{className:"label",children:"Method"}),e.jsx("select",{value:i,onChange:a=>J(a.target.value),className:"input mt-1",children:ze.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"label",children:"Endpoint Path"}),e.jsx("input",{type:"text",value:w,onChange:a=>d(a.target.value),placeholder:"/api/users/mfa-status",className:"input mt-1 font-mono text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Headers (one per line: Key: Value)"}),e.jsx("textarea",{value:H,onChange:a=>W(a.target.value),placeholder:"Accept: application/json",rows:2,className:"input mt-1 font-mono text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Query Parameters (one per line: key=value)"}),e.jsx("textarea",{value:B,onChange:a=>_(a.target.value),placeholder:`page=1
limit=100`,rows:2,className:"input mt-1 font-mono text-sm"})]}),["POST","PUT","PATCH"].includes(i)&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Request Body (JSON)"}),e.jsx("textarea",{value:I,onChange:a=>z(a.target.value),placeholder:'{"key": "value"}',rows:4,className:"input mt-1 font-mono text-sm"})]})]}),g==="standalone"&&e.jsxs("div",{className:"border border-surface-700 rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-200",children:"Authentication"}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Auth Type"}),e.jsxs("select",{value:E,onChange:a=>Y(a.target.value),className:"input mt-1",children:[e.jsx("option",{value:"",children:"None"}),e.jsx("option",{value:"api_key",children:"API Key"}),e.jsx("option",{value:"oauth2",children:"OAuth 2.0"}),e.jsx("option",{value:"bearer",children:"Bearer Token"}),e.jsx("option",{value:"basic",children:"Basic Auth"})]})]}),E==="api_key"&&e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Key Name"}),e.jsx("input",{type:"text",value:h.keyName,onChange:a=>p({...h,keyName:a.target.value}),placeholder:"X-API-Key",className:"input mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Key Value"}),e.jsx("input",{type:"password",value:h.keyValue,onChange:a=>p({...h,keyValue:a.target.value}),placeholder:"Your API key",className:"input mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Send In"}),e.jsxs("select",{value:h.location,onChange:a=>p({...h,location:a.target.value}),className:"input mt-1",children:[e.jsx("option",{value:"header",children:"Header"}),e.jsx("option",{value:"query",children:"Query Parameter"})]})]})]}),E==="oauth2"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Token URL"}),e.jsx("input",{type:"text",value:h.tokenUrl,onChange:a=>p({...h,tokenUrl:a.target.value}),placeholder:"https://auth.example.com/oauth/token",className:"input mt-1"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Client ID"}),e.jsx("input",{type:"text",value:h.clientId,onChange:a=>p({...h,clientId:a.target.value}),className:"input mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Client Secret"}),e.jsx("input",{type:"password",value:h.clientSecret,onChange:a=>p({...h,clientSecret:a.target.value}),className:"input mt-1"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Scope (optional)"}),e.jsx("input",{type:"text",value:h.scope,onChange:a=>p({...h,scope:a.target.value}),placeholder:"read write",className:"input mt-1"})]})]}),E==="bearer"&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Bearer Token"}),e.jsx("input",{type:"password",value:h.token,onChange:a=>p({...h,token:a.target.value}),placeholder:"Your bearer token",className:"input mt-1"})]}),E==="basic"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Username"}),e.jsx("input",{type:"text",value:h.username,onChange:a=>p({...h,username:a.target.value}),className:"input mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Password"}),e.jsx("input",{type:"password",value:h.password,onChange:a=>p({...h,password:a.target.value}),className:"input mt-1"})]})]})]}),e.jsxs("div",{className:"border border-surface-700 rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-200",children:"Evidence Configuration"}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Evidence Title Template"}),e.jsx("input",{type:"text",value:s,onChange:a=>ge(a.target.value),placeholder:"MFA Status - {{date}}",className:"input mt-1"}),e.jsxs("p",{className:"text-xs text-surface-500 mt-1",children:["Use ","{{field}}"," to interpolate values from the response"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Title Field (JSONPath)"}),e.jsx("input",{type:"text",value:T.titleField,onChange:a=>X({...T,titleField:a.target.value}),placeholder:"$.data.name",className:"input mt-1 font-mono text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description Field"}),e.jsx("input",{type:"text",value:T.descriptionField,onChange:a=>X({...T,descriptionField:a.target.value}),placeholder:"$.data.summary",className:"input mt-1 font-mono text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Data Field"}),e.jsx("input",{type:"text",value:T.dataField,onChange:a=>X({...T,dataField:a.target.value}),placeholder:"$.data",className:"input mt-1 font-mono text-sm"})]})]})]}),e.jsxs("div",{className:"border border-surface-700 rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-200",children:"Schedule"}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:V,onChange:a=>Ne(a.target.checked),className:"rounded border-surface-600 text-brand-500 focus:ring-brand-500"}),e.jsx("span",{className:"text-sm text-surface-300",children:"Enable scheduled collection"})]})]}),V&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Frequency"}),e.jsx("select",{value:ce,onChange:a=>be(a.target.value),className:"input mt-1",children:Ve.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})]}),A&&e.jsx("div",{className:S("p-4 rounded-lg border",A.success?"bg-green-500/10 border-green-500/20":"bg-red-500/10 border-red-500/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[A.success?e.jsx(me,{className:"w-5 h-5 text-green-400 flex-shrink-0"}):e.jsx(he,{className:"w-5 h-5 text-red-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:S("text-sm",A.success?"text-green-400":"text-red-400"),children:A.message}),A.data&&e.jsx("pre",{className:"mt-2 p-2 bg-surface-900/50 rounded text-xs text-surface-400 overflow-auto max-h-32",children:JSON.stringify(A.data,null,2)})]})]})})]}),e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-surface-700 bg-surface-800/50",children:[e.jsx("div",{children:N&&e.jsxs("button",{onClick:()=>ee.mutate(),disabled:ee.isPending,className:"btn-secondary text-sm",children:[ee.isPending?e.jsx(O,{className:"w-4 h-4 mr-1 animate-spin"}):e.jsx(O,{className:"w-4 h-4 mr-1"}),"Test Connection"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:v,className:"btn-secondary",children:"Cancel"}),e.jsx("button",{onClick:Fe,disabled:Z.isPending||!m.trim(),className:"btn-primary",children:Z.isPending?"Saving...":N?"Save Changes":"Create Collector"})]})]})]})]})}function Je({controlId:t,implementationId:u}){const n=ie(),[v,c]=r.useState(!1),[N,m]=r.useState(null),[F,k]=r.useState(null),{data:b,isLoading:g}=L({queryKey:["collectors",t,u],queryFn:()=>D.list(t,u).then(d=>d.data)}),f=q({mutationFn:d=>D.run(t,u,d),onSuccess:d=>{n.invalidateQueries({queryKey:["collectors",t,u]}),n.invalidateQueries({queryKey:["evidence"]}),d.data.success?x.success(d.data.message):x.error(d.data.message)},onError:()=>{x.error("Failed to run collector")}}),y=q({mutationFn:d=>D.delete(t,u,d),onSuccess:()=>{n.invalidateQueries({queryKey:["collectors",t,u]}),x.success("Collector deleted")},onError:()=>{x.error("Failed to delete collector")}}),l=()=>{m(null),c(!0)},o=d=>{m(d),c(!0)},j=d=>{f.mutate(d)},w=d=>{confirm(`Are you sure you want to delete the collector "${d.name}"?`)&&y.mutate(d.id)};return g?e.jsxs("div",{className:"flex items-center justify-center py-8 text-surface-500",children:[e.jsx(O,{className:"w-5 h-5 animate-spin mr-2"}),"Loading collectors..."]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-surface-100",children:"Evidence Collectors"}),e.jsx("p",{className:"text-sm text-surface-400",children:"Configure API endpoints to automatically collect evidence for this control"})]}),e.jsxs("button",{onClick:l,className:"btn-primary text-sm",children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"Add Collector"]})]}),b?.length===0?e.jsxs("div",{className:"text-center py-8 border border-dashed border-surface-700 rounded-lg",children:[e.jsx(pe,{className:"w-10 h-10 mx-auto text-surface-600 mb-3"}),e.jsx("p",{className:"text-surface-400 mb-3",children:"No evidence collectors configured"}),e.jsxs("button",{onClick:l,className:"btn-secondary text-sm",children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"Create your first collector"]})]}):e.jsx("div",{className:"space-y-3",children:b?.map(d=>e.jsx(We,{collector:d,isExpanded:F===d.id,onToggle:()=>k(F===d.id?null:d.id),onEdit:()=>o(d),onRun:()=>j(d.id),onDelete:()=>w(d),isRunning:f.isPending&&f.variables===d.id,controlId:t,implementationId:u},d.id))}),v&&e.jsx(Ge,{controlId:t,implementationId:u,collector:N,onClose:()=>{c(!1),m(null)}})]})}function We({collector:t,isExpanded:u,onToggle:n,onEdit:v,onRun:c,onDelete:N,isRunning:m,controlId:F,implementationId:k}){const{data:b}=L({queryKey:["collector-runs",t.id],queryFn:()=>D.getRuns(F,k,t.id,5).then(o=>o.data),enabled:u}),g={success:{icon:me,color:"text-green-400",bg:"bg-green-500/20"},error:{icon:he,color:"text-red-400",bg:"bg-red-500/20"},running:{icon:O,color:"text-blue-400",bg:"bg-blue-500/20"}},f=t.lastRunStatus,y=f?g[f]?.icon:Q,l=f?g[f]?.color:"text-surface-400";return e.jsxs("div",{className:"border border-surface-700 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-surface-800/50 cursor-pointer",onClick:n,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:S("p-2 rounded-lg",t.mode==="integration"?"bg-brand-500/20":"bg-surface-700"),children:t.mode==="integration"?e.jsx(te,{className:"w-5 h-5 text-brand-400"}):e.jsx(pe,{className:"w-5 h-5 text-surface-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-surface-100",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-surface-500",children:[e.jsx("span",{className:"uppercase",children:t.method}),e.jsx("span",{children:t.endpoint||"/"}),t.scheduleEnabled&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-surface-700 rounded",children:[e.jsx(Q,{className:"w-3 h-3 inline mr-1"}),t.scheduleFrequency]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[t.lastRunAt&&e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(y,{className:S("w-4 h-4",l,f==="running"&&"animate-spin")}),e.jsx("span",{className:"text-surface-400",children:He(new Date(t.lastRunAt),{addSuffix:!0})})]}),e.jsxs("div",{className:"text-xs text-surface-500",children:[t.successfulRuns,"/",t.totalRuns," runs"]}),e.jsxs("div",{className:"flex items-center gap-1",onClick:o=>o.stopPropagation(),children:[e.jsx("button",{onClick:c,disabled:m,className:"p-1.5 text-surface-400 hover:text-green-400 hover:bg-surface-700 rounded transition-colors",title:"Run now",children:m?e.jsx(O,{className:"w-4 h-4 animate-spin"}):e.jsx(Ee,{className:"w-4 h-4"})}),e.jsx("button",{onClick:v,className:"p-1.5 text-surface-400 hover:text-surface-200 hover:bg-surface-700 rounded transition-colors",title:"Edit",children:e.jsx(fe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:N,className:"p-1.5 text-surface-400 hover:text-red-400 hover:bg-surface-700 rounded transition-colors",title:"Delete",children:e.jsx(je,{className:"w-4 h-4"})})]}),u?e.jsx(Te,{className:"w-4 h-4 text-surface-500"}):e.jsx(Pe,{className:"w-4 h-4 text-surface-500"})]})]}),u&&e.jsxs("div",{className:"p-4 border-t border-surface-700 space-y-4",children:[t.description&&e.jsx("p",{className:"text-sm text-surface-400",children:t.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-500",children:"Mode:"})," ",e.jsx("span",{className:"text-surface-300 capitalize",children:t.mode}),t.integration&&e.jsxs("span",{className:"ml-2 text-brand-400",children:["(",t.integration.name,")"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-500",children:"Evidence Type:"})," ",e.jsx("span",{className:"text-surface-300 capitalize",children:t.evidenceType})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-500",children:"Base URL:"})," ",e.jsx("span",{className:"text-surface-300 font-mono text-xs",children:t.baseUrl||(t.integration?"From integration":"Not set")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-500",children:"Endpoint:"})," ",e.jsx("span",{className:"text-surface-300 font-mono text-xs",children:t.endpoint||"/"})]})]}),t.scheduleEnabled&&e.jsx("div",{className:"p-3 bg-surface-800/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Q,{className:"w-4 h-4 text-surface-500"}),e.jsxs("span",{className:"text-surface-300",children:["Scheduled: ",e.jsx("span",{className:"capitalize",children:t.scheduleFrequency})]}),t.nextRunAt&&e.jsxs("span",{className:"text-surface-500",children:["• Next run: ",xe(new Date(t.nextRunAt),"MMM dd, yyyy HH:mm")]})]})}),b&&b.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-medium text-surface-300 mb-2",children:"Recent Runs"}),e.jsx("div",{className:"space-y-2",children:b.map(o=>{const j=o.status,w=g[j]?.icon||Q;return e.jsxs("div",{className:"flex items-center justify-between p-2 bg-surface-800/30 rounded text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:S("w-4 h-4",g[j]?.color)}),e.jsx("span",{className:"text-surface-300 capitalize",children:o.status}),e.jsx("span",{className:"text-surface-500",children:"•"}),e.jsx("span",{className:"text-surface-500",children:o.triggeredBy}),o.evidenceCreated>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-surface-500",children:"•"}),e.jsxs("span",{className:"text-green-400",children:[o.evidenceCreated," evidence created"]})]})]}),e.jsx("span",{className:"text-surface-500",children:xe(new Date(o.startedAt),"MMM dd HH:mm")})]},o.id)})})]}),t.lastRunError&&e.jsx("div",{className:"p-3 bg-red-500/10 border border-red-500/20 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-400",children:t.lastRunError})})]})]})}const Ye=r.createContext(null);function Xe(){const t=r.useContext(Ye);return t||{status:"disconnected",send:()=>{},subscribeToEntity:()=>{},unsubscribeFromEntity:()=>{}}}function Ze({entityType:t,entityId:u}){const{status:n,subscribeToEntity:v,unsubscribeFromEntity:c}=Xe();return r.useEffect(()=>(v(t,u),()=>{c(t,u)}),[t,u,v,c]),n!=="connected"?null:e.jsxs("div",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-500/10 px-2 py-0.5 text-xs text-emerald-300",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"}),"Live updates"]})}const es=[{value:"not_started",label:"Not Started"},{value:"in_progress",label:"In Progress"},{value:"implemented",label:"Implemented"},{value:"not_applicable",label:"Not Applicable"}],ss=[{value:"weekly",label:"Weekly"},{value:"monthly",label:"Monthly"},{value:"quarterly",label:"Quarterly"},{value:"semi_annually",label:"Semi-Annually"},{value:"annually",label:"Annually"}];function os(){const{id:t}=qe(),u=Re(),n=Ae(),{hasPermission:v}=$e(),c=ie(),[N,m]=r.useState(!1),[F,k]=r.useState(!1),[b,g]=r.useState(!1),[f,y]=r.useState("details"),[l,o]=r.useState({title:"",description:"",guidance:"",tags:""}),[j,w]=r.useState({ownerId:"",testingFrequency:"",effectivenessScore:"",implementationNotes:""}),d=n.state?.from||"/controls",{data:i,isLoading:J}=L({queryKey:["control",t],queryFn:()=>ae.get(t).then(s=>s.data),enabled:!!t}),{data:H}=L({queryKey:["users"],queryFn:()=>Qe.list().then(s=>s.data)}),W=H?.data||[],B=q({mutationFn:s=>{if(!i?.implementation?.id)throw new Error("No implementation");return ue.update(i.implementation.id,{status:s})},onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),c.invalidateQueries({queryKey:["controls"]}),x.success("Status updated")},onError:()=>{x.error("Failed to update status")}}),_=q({mutationFn:s=>ae.update(t,s),onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),c.invalidateQueries({queryKey:["controls"]}),x.success("Control updated")},onError:()=>{x.error("Failed to update control")}}),I=q({mutationFn:s=>{if(!i?.implementation?.id)throw new Error("No implementation");return ue.update(i.implementation.id,s)},onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),c.invalidateQueries({queryKey:["controls"]}),x.success("Implementation updated")},onError:()=>{x.error("Failed to update implementation")}}),z=q({mutationFn:s=>Ke.unlink(s,t),onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),c.invalidateQueries({queryKey:["controls"]}),c.invalidateQueries({queryKey:["evidence"]}),x.success("Evidence unlinked")},onError:()=>{x.error("Failed to unlink evidence")}}),E=q({mutationFn:s=>le.unlinkFromControl(s,t),onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),c.invalidateQueries({queryKey:["controls"]}),c.invalidateQueries({queryKey:["policies"]}),x.success("Policy unlinked")},onError:()=>{x.error("Failed to unlink policy")}}),Y=()=>{if(!i)return;const s=i.implementation;o({title:i.title,description:i.description,guidance:i.guidance||"",tags:(i.tags||[]).join(", ")}),w({ownerId:s?.ownerId||"",testingFrequency:s?.testingFrequency||"quarterly",effectivenessScore:s?.effectivenessScore?.toString()||"",implementationNotes:s?.implementationNotes||""}),m(!0)},h=async()=>{await _.mutateAsync({title:l.title,description:l.description,guidance:l.guidance||void 0,tags:l.tags?l.tags.split(",").map(s=>s.trim()).filter(Boolean):[]}),i?.implementation&&await I.mutateAsync({ownerId:j.ownerId||null,testingFrequency:j.testingFrequency,effectivenessScore:j.effectivenessScore?parseInt(j.effectivenessScore):null,implementationNotes:j.implementationNotes||null}),m(!1)};if(J)return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx(_e,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(K,{title:!0}),e.jsx(K,{title:!0}),e.jsx(K,{title:!0})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(K,{title:!0}),e.jsx(K,{title:!0})]})]})]});if(!i)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-surface-400",children:"Control not found"})});const p=i.implementation;return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs(G,{to:d,className:"inline-flex items-center text-sm text-surface-400 hover:text-surface-100 mb-4",children:[e.jsx(Me,{className:"w-4 h-4 mr-1"}),"Back to Controls"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-brand-400 text-lg",children:i.controlId}),e.jsx("h1",{className:"text-2xl font-bold text-surface-100",children:i.title}),e.jsx(Ze,{entityType:"control",entityId:i.id})]}),e.jsx("p",{className:"text-surface-400 mt-2 max-w-2xl",children:i.description})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[v("controls:update")&&e.jsx(R,{variant:"outline",onClick:Y,leftIcon:e.jsx(fe,{className:"w-4 h-4"}),children:"Edit"}),v("controls:delete")&&e.jsx(R,{variant:"danger",onClick:()=>k(!0),leftIcon:e.jsx(je,{className:"w-4 h-4"}),children:"Delete"})]})]}),N&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"card w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-4 border-b border-surface-800 flex items-center justify-between sticky top-0 bg-surface-900",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Edit Control"}),e.jsx("button",{onClick:()=>m(!1),className:"p-1 hover:bg-surface-700 rounded",children:e.jsx(U,{className:"w-5 h-5 text-surface-400"})})]}),e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-300 mb-3 uppercase tracking-wide",children:"Control Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Title"}),e.jsx("input",{type:"text",value:l.title,onChange:s=>o({...l,title:s.target.value}),className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Description"}),e.jsx("textarea",{value:l.description,onChange:s=>o({...l,description:s.target.value}),rows:3,className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Tags (comma-separated)"}),e.jsx("input",{type:"text",value:l.tags,onChange:s=>o({...l,tags:s.target.value}),placeholder:"e.g., authentication, encryption, monitoring",className:"input w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Implementation Guidance"}),e.jsx("textarea",{value:l.guidance,onChange:s=>o({...l,guidance:s.target.value}),rows:3,className:"input w-full"})]})]})]}),i.implementation&&e.jsxs("div",{className:"border-t border-surface-800 pt-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-300 mb-3 uppercase tracking-wide",children:"Implementation Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Owner"}),e.jsxs("select",{value:j.ownerId,onChange:s=>w({...j,ownerId:s.target.value}),className:"input w-full",children:[e.jsx("option",{value:"",children:"Unassigned"}),W?.map(s=>e.jsxs("option",{value:s.id,children:[s.displayName," (",s.role,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Testing Frequency"}),e.jsx("select",{value:j.testingFrequency,onChange:s=>w({...j,testingFrequency:s.target.value}),className:"input w-full",children:ss.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label mb-1",children:"Effectiveness Score (0-100)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:j.effectivenessScore,onChange:s=>w({...j,effectivenessScore:s.target.value}),placeholder:"Not rated",className:"input w-full"}),e.jsx("p",{className:"text-xs text-surface-500 mt-1",children:"How effective is this control at mitigating risk?"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"label mb-1",children:"Implementation Notes"}),e.jsx("textarea",{value:j.implementationNotes,onChange:s=>w({...j,implementationNotes:s.target.value}),rows:3,placeholder:"Notes about how this control is implemented...",className:"input w-full"})]})]})]})]}),e.jsxs("div",{className:"p-4 border-t border-surface-800 flex justify-end gap-3 sticky bottom-0 bg-surface-900",children:[e.jsx(R,{variant:"secondary",onClick:()=>m(!1),children:"Cancel"}),e.jsx(R,{onClick:h,isLoading:_.isPending||I.isPending,children:"Save Changes"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Implementation Status"}),p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label mb-2 block",children:"Status"}),e.jsx("select",{value:p.status,onChange:s=>B.mutate(s.target.value),disabled:!v("controls:update"),className:"input w-full max-w-xs",children:es.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-4 border-t border-surface-800",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-surface-500",children:"Owner"}),e.jsx("p",{className:"text-surface-200",children:p.owner?.displayName||"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-surface-500",children:"Testing Frequency"}),e.jsx("p",{className:"text-surface-200 capitalize",children:p.testingFrequency?.replace("_"," ")||"Quarterly"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-surface-500",children:"Last Tested"}),e.jsx("p",{className:"text-surface-200",children:p?.lastTestDate?new Date(p.lastTestDate).toLocaleDateString():"Never"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-surface-500",children:"Effectiveness Score"}),e.jsx("p",{className:"text-surface-200",children:p.effectivenessScore!==null?`${p.effectivenessScore}%`:"Not rated"})]})]}),p.implementationNotes&&e.jsxs("div",{className:"pt-4 border-t border-surface-800",children:[e.jsx("p",{className:"text-sm text-surface-500 mb-2",children:"Implementation Notes"}),e.jsx("p",{className:"text-surface-300 text-sm",children:p.implementationNotes})]})]}):e.jsx("p",{className:"text-surface-500",children:"No implementation data"})]}),e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Evidence"}),e.jsxs(G,{to:`/evidence?controlId=${t}`,className:"btn-outline text-sm",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Link Evidence"]})]}),(i?.evidenceLinks?.length??0)>0?e.jsx("div",{className:"space-y-2",children:i?.evidenceLinks?.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-surface-800 rounded-lg group",children:[e.jsxs(G,{to:`/evidence/${s.evidence.id}`,className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx(ne,{className:"w-5 h-5 text-surface-400"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-surface-200 hover:text-brand-400 truncate",children:s.evidence.title}),e.jsxs("p",{className:"text-xs text-surface-500",children:[s.evidence.type," • ",s.evidence.status]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:S("badge text-xs",s.evidence.status==="approved"?"badge-success":s.evidence.status==="expired"?"badge-danger":"badge-warning"),children:s.evidence.status}),v("evidence:write")&&e.jsx("button",{onClick:()=>z.mutate(s.evidence.id),disabled:z.isPending,className:"p-1 text-surface-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Unlink evidence",children:e.jsx(U,{className:"w-4 h-4"})})]})]},s.id))}):e.jsx("p",{className:"text-surface-500 text-sm",children:"No evidence linked to this control"})]}),e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Linked Policies"}),v("policies:write")&&e.jsxs("button",{onClick:()=>g(!0),className:"btn-outline text-sm",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Link Policy"]})]}),e.jsx("p",{className:"text-xs text-surface-500 mb-3",children:"Policies that serve as evidence for this control"}),(i?.policyLinks?.length??0)>0?e.jsx("div",{className:"space-y-2",children:i?.policyLinks?.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-surface-800 rounded-lg group",children:[e.jsxs(G,{to:`/policies/${s.policy?.id}`,className:"flex items-center gap-3 flex-1 min-w-0 hover:text-brand-400",children:[e.jsx(ne,{className:"w-5 h-5 text-brand-400"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-surface-200 truncate",children:s.policy?.title}),e.jsxs("p",{className:"text-xs text-surface-500 capitalize",children:[s.policy?.category?.replace(/_/g," ")," • v",s.policy?.version]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:S("badge text-xs",s.policy?.status==="published"||s.policy?.status==="approved"?"badge-success":s.policy?.status==="retired"?"badge-danger":"badge-warning"),children:s.policy?.status}),v("policies:write")&&e.jsx("button",{onClick:()=>E.mutate(s.policy?.id),disabled:E.isPending,className:"p-1 text-surface-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Unlink policy",children:e.jsx(U,{className:"w-4 h-4"})})]})]},s.id))}):e.jsx("p",{className:"text-surface-500 text-sm",children:"No policies linked to this control."})]}),i.implementation&&e.jsx("div",{className:"card p-6",children:e.jsx(Je,{controlId:i.id,implementationId:i.implementation.id})}),e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Test History"}),(p?.tests?.length??0)>0?e.jsx("div",{className:"space-y-3",children:p?.tests?.map(s=>e.jsxs("div",{className:"flex items-start justify-between p-3 bg-surface-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:S("badge",s.result==="pass"?"badge-success":s.result==="fail"?"badge-danger":"badge-warning"),children:s.result}),e.jsxs("span",{className:"text-xs text-surface-500",children:[s.testType," test"]})]}),s.findings&&e.jsx("p",{className:"text-sm text-surface-400 mt-2",children:s.findings})]}),e.jsx("span",{className:"text-xs text-surface-500",children:new Date(s.testedAt).toLocaleDateString()})]},s.id))}):e.jsx("p",{className:"text-surface-500 text-sm",children:"No test history"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Details"}),e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Category"}),e.jsx("dd",{className:"text-sm text-surface-200 capitalize mt-1",children:i.category.replace("_"," ")})]}),i?.subcategory&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Subcategory"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:i.subcategory})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Type"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:i.isCustom?"Custom":"System"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Tags"}),e.jsx("dd",{className:"flex flex-wrap gap-1 mt-1",children:(i?.tags?.length??0)>0?i?.tags?.map(s=>e.jsx("span",{className:"badge badge-neutral text-xs",children:s},s)):e.jsx("span",{className:"text-sm text-surface-500",children:"No tags"})})]})]})]}),e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Framework Mappings"}),(i?.mappings?.length??0)>0?e.jsx("div",{className:"space-y-2",children:i?.mappings?.map(s=>e.jsxs("div",{className:"p-2 bg-surface-800 rounded-lg",children:[e.jsx("p",{className:"text-sm text-brand-400",children:s.framework.name}),e.jsxs("p",{className:"text-xs text-surface-400 mt-1",children:[s.requirement.reference," - ",s.requirement.title]})]},s.id))}):e.jsx("p",{className:"text-surface-500 text-sm",children:"Not mapped to any frameworks"})]}),i.guidance&&e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Implementation Guidance"}),e.jsx("p",{className:"text-sm text-surface-400",children:i.guidance})]})]})]}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsx("div",{className:"border-b border-surface-700 px-4",children:e.jsxs("nav",{className:"flex gap-6","aria-label":"Tabs",children:[e.jsxs("button",{onClick:()=>y("comments"),className:S("py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2",f==="comments"?"border-brand-500 text-brand-400":"border-transparent text-surface-400 hover:text-surface-200 hover:border-surface-600"),children:[e.jsx(De,{className:"w-4 h-4"}),"Comments"]}),e.jsxs("button",{onClick:()=>y("tasks"),className:S("py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2",f==="tasks"?"border-brand-500 text-brand-400":"border-transparent text-surface-400 hover:text-surface-200 hover:border-surface-600"),children:[e.jsx(Ie,{className:"w-4 h-4"}),"Tasks"]}),e.jsxs("button",{onClick:()=>y("history"),className:S("py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2",f==="history"?"border-brand-500 text-brand-400":"border-transparent text-surface-400 hover:text-surface-200 hover:border-surface-600"),children:[e.jsx(Q,{className:"w-4 h-4"}),"History"]})]})}),e.jsxs("div",{className:"p-6",children:[f==="comments"&&e.jsx(Ue,{entityType:"control",entityId:t}),f==="tasks"&&e.jsx(Oe,{entityType:"control",entityId:t}),f==="history"&&e.jsx(Be,{entityType:"control",entityId:t})]})]}),b&&e.jsx(as,{controlId:t,existingPolicyIds:i.policyLinks?.map(s=>s.policy?.id)||[],onClose:()=>g(!1),onSuccess:()=>{c.invalidateQueries({queryKey:["control",t]}),g(!1)}}),F&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-surface-900 border border-surface-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-surface-100 mb-2",children:"Delete Control"}),e.jsxs("p",{className:"text-surface-400 mb-6",children:['Are you sure you want to delete "',i?.title,'"? This action cannot be undone.']}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(R,{variant:"secondary",onClick:()=>k(!1),children:"Cancel"}),e.jsx(R,{variant:"danger",onClick:async()=>{try{await ae.delete(t),x.success("Control deleted successfully"),u("/controls")}catch(s){console.error("Error deleting control:",s),x.error("Failed to delete control")}},children:"Delete"})]})]})})]})}function as({controlId:t,existingPolicyIds:u,onClose:n,onSuccess:v}){const[c,N]=r.useState(""),[m,F]=r.useState([]),{data:k,isLoading:b}=L({queryKey:["policies-for-linking",c],queryFn:()=>le.list({search:c.trim()||void 0,limit:100}).then(l=>l.data),staleTime:0}),g=q({mutationFn:async()=>{await Promise.all(m.map(l=>le.linkToControls(l,[t])))},onSuccess:()=>{x.success("Policies linked to control!"),v()},onError:l=>{x.error(l.message||"Failed to link policies")}}),f=(k?.data||[]).filter(l=>!u.includes(l.id)),y=l=>{F(o=>o.includes(l)?o.filter(j=>j!==l):[...o,l])};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:n}),e.jsxs("div",{className:"relative bg-surface-900 border border-surface-800 rounded-xl w-full max-w-lg mx-4 p-6 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Link Policies to Control"}),e.jsx("button",{onClick:n,className:"text-surface-400 hover:text-surface-100",children:e.jsx(U,{className:"w-5 h-5"})})]}),e.jsx("p",{className:"text-sm text-surface-400 mb-4",children:"Select policies to link as evidence for this control:"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("input",{type:"text",placeholder:"Search policies...",value:c,onChange:l=>N(l.target.value),className:"input pl-10"}),e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-surface-500"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto space-y-2 min-h-[200px] max-h-[300px]",children:b?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-surface-700 rounded-full border-t-brand-500"}),e.jsx("span",{className:"ml-2 text-surface-400",children:"Searching..."})]}):f.length===0?e.jsx("p",{className:"text-surface-500 text-center py-8",children:c?`No policies found for "${c}"`:"All policies are already linked"}):f.map(l=>e.jsxs("label",{className:S("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",m.includes(l.id)?"bg-brand-500/20 border border-brand-500/50":"bg-surface-800 hover:bg-surface-700"),children:[e.jsx("input",{type:"checkbox",checked:m.includes(l.id),onChange:()=>y(l.id),className:"rounded border-surface-600"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-surface-200 truncate",children:l.title}),e.jsxs("p",{className:"text-xs text-surface-500 capitalize",children:[l.category?.replace(/_/g," ")," • v",l.version," • ",l.status]})]})]},l.id))}),m.length>0&&e.jsxs("p",{className:"text-sm text-surface-400 mt-3",children:[m.length," policy(ies) selected"]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4 pt-4 border-t border-surface-800",children:[e.jsx(R,{variant:"secondary",onClick:n,children:"Cancel"}),e.jsx(R,{onClick:()=>g.mutate(),disabled:m.length===0,isLoading:g.isPending,children:"Link Policies"})]})]})]})}export{os as default};
