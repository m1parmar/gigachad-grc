const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CWk44mA8.js","assets/vendor-C9-ySRfk.css"])))=>i.map(i=>d[i]);
import{aS as K,u as H,r,b as Q,c as _,j as e,y as T,aT as V,aF as U,aM as G,S as J,aa as W,L as P,aO as Y,B as F,aJ as $,aV as X,w as Z,m as z,aC as ee,x as se,aD as w,an as O,aW as te}from"./vendor-CWk44mA8.js";import{b as ae,B as g,l as S}from"./index-CiJwl-Bo.js";import{E as re}from"./EntityAuditHistory-C0v1gX0U.js";import{b as ie,c as E}from"./Skeleton-DVOICtGK.js";import"./vendor-http-B9ygI19o.js";import"./vendor-date-CWdg4M78.js";const B={screenshot:V,document:T,default:T},I={pending_review:{label:"Pending Review",color:"text-yellow-400 bg-yellow-400/10",icon:W},approved:{label:"Approved",color:"text-green-400 bg-green-400/10",icon:J},rejected:{label:"Rejected",color:"text-red-400 bg-red-400/10",icon:G},expired:{label:"Expired",color:"text-surface-400 bg-surface-400/10",icon:U}};function fe(){const{id:a}=K(),{hasPermission:c}=ae(),l=H(),[d,o]=r.useState(!1),[x,f]=r.useState(""),[n,i]=r.useState(!1),[m,u]=r.useState("details"),{data:s,isLoading:p}=Q({queryKey:["evidence",a],queryFn:()=>S.get(a).then(t=>t.data),enabled:!!a}),h=_({mutationFn:t=>S.review(a,t),onSuccess:()=>{l.invalidateQueries({queryKey:["evidence",a]}),l.invalidateQueries({queryKey:["evidence"]}),w.success("Evidence reviewed"),o(!1),f("")},onError:()=>{w.error("Failed to review evidence")}});r.useEffect(()=>{const t=C=>{C.key==="Escape"&&n&&i(!1)};return n&&(document.addEventListener("keydown",t),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",t),document.body.style.overflow=""}},[n]);const b=_({mutationFn:t=>S.unlink(a,t),onSuccess:()=>{l.invalidateQueries({queryKey:["evidence",a]}),l.invalidateQueries({queryKey:["evidence"]}),l.invalidateQueries({queryKey:["controls"]}),w.success("Control unlinked")},onError:()=>{w.error("Failed to unlink control")}}),y=async()=>{try{const C=(await S.getDownloadUrl(a)).data.url;window.open(C,"_blank")}catch{w.error("Failed to get download URL")}};if(p)return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx(ie,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(E,{title:!0}),e.jsx(E,{title:!0})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(E,{title:!0}),e.jsx(E,{title:!0})]})]})]});if(!s)return e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-surface-400",children:"Evidence not found"})});const v=B[s.type]||B.default,j=I[s.status]||I.pending_review,L=j.icon,N=s.mimeType?.startsWith("image/"),k=s.mimeType==="application/pdf",R=s.mimeType?.startsWith("text/")||["application/json","application/xml","application/javascript"].includes(s.mimeType),D=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(s.mimeType),A=["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(s.mimeType),q=N||k||R||D||A;return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsxs(P,{to:"/evidence",className:"inline-flex items-center text-sm text-surface-400 hover:text-surface-100 mb-4",children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"Back to Evidence"]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-3 bg-surface-800 rounded-lg",children:e.jsx(v,{className:"w-8 h-8 text-surface-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-surface-100",children:s.title}),e.jsx("p",{className:"text-surface-400 mt-1",children:s.filename}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsxs("span",{className:F("badge",j.color),children:[e.jsx(L,{className:"w-3 h-3 mr-1"}),j.label]}),e.jsx("span",{className:"badge badge-neutral capitalize",children:s.type})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",onClick:y,leftIcon:e.jsx($,{className:"w-4 h-4"}),children:"Download"}),c("evidence:review")&&s.status==="pending_review"&&e.jsx(g,{onClick:()=>o(!0),children:"Review"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Preview"}),q?e.jsxs("div",{className:"border border-surface-800 rounded-lg overflow-hidden bg-surface-950",children:[N&&e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:`/api/evidence/${s.id}/preview`,alt:s.title,className:"max-w-full max-h-[500px] mx-auto cursor-pointer transition-opacity hover:opacity-90",onClick:()=>i(!0),onError:t=>{t.target.style.display="none"}}),e.jsx("button",{onClick:()=>i(!0),className:"absolute top-3 right-3 p-2 bg-black/50 hover:bg-black/70 rounded-lg text-white opacity-0 group-hover:opacity-100 transition-opacity",title:"Expand image",children:e.jsx(X,{className:"w-5 h-5"})})]}),k&&e.jsx("iframe",{src:`/api/evidence/${s.id}/preview`,className:"w-full h-[600px]",title:s.title}),R&&e.jsx(ce,{evidenceId:s.id}),D&&e.jsx(le,{evidenceId:s.id}),A&&e.jsx(ne,{evidenceId:s.id})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-surface-500",children:[e.jsx(v,{className:"w-16 h-16 mb-4"}),e.jsx("p",{children:"Preview not available for this file type"}),e.jsx("p",{className:"text-sm mt-1",children:"Click download to view the file"})]})]}),s.description&&e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Description"}),e.jsx("p",{className:"text-surface-300",children:s.description})]}),e.jsxs("div",{className:"card p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Linked Controls"}),e.jsxs("span",{className:"badge badge-neutral",children:[s.controlLinks?.length||0," control(s)"]})]}),(s?.controlLinks?.length??0)>0?e.jsx("div",{className:"space-y-2",children:s?.controlLinks?.map(t=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-surface-800 rounded-lg group",children:[e.jsxs(P,{to:`/controls/${t.control?.id}`,className:"flex items-center gap-3 flex-1 hover:bg-surface-700 -m-3 p-3 rounded-lg transition-colors",children:[e.jsx(Z,{className:"w-5 h-5 text-brand-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-mono text-brand-400",children:t.control?.controlId}),e.jsx("p",{className:"text-sm text-surface-300",children:t.control?.title})]})]}),c("evidence:write")&&e.jsx("button",{onClick:()=>b.mutate(t.control?.id),disabled:b.isPending,className:"p-1 text-surface-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity",title:"Unlink control",children:e.jsx(z,{className:"w-4 h-4"})})]},t.id))}):e.jsx("p",{className:"text-surface-500 text-sm",children:"This evidence is not linked to any controls"})]}),s.reviewedAt&&e.jsxs("div",{className:"card p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Review"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{className:"w-4 h-4 text-surface-500"}),e.jsx("span",{className:"text-surface-400",children:"Reviewed by:"}),e.jsx("span",{className:"text-surface-200",children:s.reviewedBy||"Unknown"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(U,{className:"w-4 h-4 text-surface-500"}),e.jsx("span",{className:"text-surface-400",children:"Reviewed on:"}),e.jsx("span",{className:"text-surface-200",children:new Date(s.reviewedAt).toLocaleDateString()})]}),s.reviewNotes&&e.jsxs("div",{className:"mt-3 p-3 bg-surface-800 rounded-lg",children:[e.jsx("p",{className:"text-sm text-surface-500 mb-1",children:"Notes:"}),e.jsx("p",{className:"text-sm text-surface-300",children:s.reviewNotes})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Details"}),e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"File Size"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:M(s.size)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"File Type"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:s.mimeType||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Source"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1 capitalize",children:s.source})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Collected"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:s.collectedAt?new Date(s.collectedAt).toLocaleDateString():"—"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Valid From"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:s.validFrom?new Date(s.validFrom).toLocaleDateString():"—"})]}),s.validUntil&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Valid Until"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:new Date(s.validUntil).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Version"}),e.jsxs("dd",{className:"text-sm text-surface-200 mt-1",children:["v",s.version]})]})]})]}),(s?.tags?.length??0)>0&&e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s?.tags?.map(t=>e.jsx("span",{className:"badge badge-neutral text-xs",children:t},t))})]}),s.folder&&e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Folder"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-surface-400"}),e.jsx("span",{className:"text-sm text-surface-200",children:s.folder.name})]})]}),e.jsxs("div",{className:"card p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-100 mb-4",children:"Audit"}),e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Created"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:new Date(s.createdAt).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Last Updated"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:new Date(s.updatedAt).toLocaleString()})]})]})]})]})]}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsx("div",{className:"border-b border-surface-700 px-4",children:e.jsxs("nav",{className:"flex gap-6","aria-label":"Tabs",children:[e.jsxs("button",{onClick:()=>u("details"),className:F("py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2",m==="details"?"border-brand-500 text-brand-400":"border-transparent text-surface-400 hover:text-surface-200 hover:border-surface-600"),children:[e.jsx(T,{className:"w-4 h-4"}),"Details"]}),e.jsxs("button",{onClick:()=>u("history"),className:F("py-3 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2",m==="history"?"border-brand-500 text-brand-400":"border-transparent text-surface-400 hover:text-surface-200 hover:border-surface-600"),children:[e.jsx(W,{className:"w-4 h-4"}),"History"]})]})}),e.jsxs("div",{className:"p-6",children:[m==="details"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-surface-100",children:"File Information"}),e.jsxs("dl",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"File Name"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:s.filename})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"File Size"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:M(s.size)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"MIME Type"}),e.jsx("dd",{className:"text-sm text-surface-200 mt-1",children:s.mimeType||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs text-surface-500",children:"Version"}),e.jsxs("dd",{className:"text-sm text-surface-200 mt-1",children:["v",s.version]})]})]})]}),m==="history"&&e.jsx(re,{entityType:"evidence",entityId:a})]})]}),d&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>o(!1)}),e.jsxs("div",{className:"relative bg-surface-900 border border-surface-800 rounded-xl w-full max-w-md mx-4 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100 mb-4",children:"Review Evidence"}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Notes (optional)"}),e.jsx("textarea",{value:x,onChange:t=>f(t.target.value),className:"input mt-1",rows:3,placeholder:"Add review notes..."})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(g,{variant:"secondary",onClick:()=>o(!1),children:"Cancel"}),e.jsx(g,{variant:"danger",onClick:()=>h.mutate({status:"rejected",notes:x}),isLoading:h.isPending,children:"Reject"}),e.jsx(g,{onClick:()=>h.mutate({status:"approved",notes:x}),isLoading:h.isPending,children:"Approve"})]})]})]}),n&&N&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90",onClick:()=>i(!1),children:[e.jsx("button",{onClick:()=>i(!1),className:"absolute top-4 right-4 p-2 text-white/70 hover:text-white bg-black/50 hover:bg-black/70 rounded-lg transition-colors z-10",children:e.jsx(z,{className:"w-6 h-6"})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),y()},className:"absolute top-4 right-16 p-2 text-white/70 hover:text-white bg-black/50 hover:bg-black/70 rounded-lg transition-colors z-10",title:"Download",children:e.jsx($,{className:"w-6 h-6"})}),e.jsxs("div",{className:"relative max-w-[95vw] max-h-[95vh] flex items-center justify-center",onClick:t=>t.stopPropagation(),children:[e.jsx("img",{src:`/api/evidence/${s.id}/preview`,alt:s.title,className:"max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent rounded-b-lg",children:[e.jsx("p",{className:"text-white font-medium",children:s.title}),e.jsx("p",{className:"text-white/60 text-sm",children:s.filename})]})]}),e.jsxs("p",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 text-white/40 text-sm",children:["Press ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/10 rounded text-xs",children:"ESC"})," or click anywhere to close"]})]})]})}function M(a){if(a===0)return"0 Bytes";const c=1024,l=["Bytes","KB","MB","GB"],d=Math.floor(Math.log(a)/Math.log(c));return parseFloat((a/Math.pow(c,d)).toFixed(2))+" "+l[d]}function ce({evidenceId:a}){const[c,l]=r.useState(null),[d,o]=r.useState(!0),[x,f]=r.useState(null);return r.useEffect(()=>{fetch(`/api/evidence/${a}/preview`).then(async n=>{if(!n.ok)throw new Error("Failed to load preview");const i=await n.text();l(i)}).catch(n=>f(n.message)).finally(()=>o(!1))},[a]),d?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-surface-700 rounded-full border-t-brand-500"})}):x?e.jsx("div",{className:"text-center py-8 text-red-400",children:e.jsx("p",{children:"Failed to load preview"})}):e.jsx("pre",{className:"p-4 text-sm text-surface-300 overflow-auto max-h-[500px] font-mono whitespace-pre-wrap break-words",children:c})}function le({evidenceId:a}){const[c,l]=r.useState([]),[d,o]=r.useState(0),[x,f]=r.useState(!0),[n,i]=r.useState(null);if(r.useEffect(()=>{(async()=>{try{const s=await fetch(`/api/evidence/${a}/preview`);if(!s.ok)throw new Error("Failed to load file");const p=await s.arrayBuffer(),h=await O(()=>import("./vendor-CWk44mA8.js").then(v=>v.e),__vite__mapDeps([0,1])),b=new h.Workbook;await b.xlsx.load(p);const y=b.worksheets.map(v=>{const j=[];return v.eachRow(L=>{const N=[];L.eachCell({includeEmpty:!0},k=>{N.push(k.value)}),j.push(N)}),{name:v.name,data:j}});l(y)}catch(s){i(s.message)}finally{f(!1)}})()},[a]),x)return e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-surface-700 rounded-full border-t-brand-500"}),e.jsx("span",{className:"ml-2 text-surface-400",children:"Loading spreadsheet..."})]});if(n)return e.jsx("div",{className:"text-center py-8 text-red-400",children:e.jsxs("p",{children:["Failed to load spreadsheet: ",n]})});const m=c[d];return e.jsxs("div",{className:"overflow-hidden",children:[c.length>1&&e.jsx("div",{className:"flex gap-1 p-2 bg-surface-800 border-b border-surface-700 overflow-x-auto",children:c.map((u,s)=>e.jsx("button",{onClick:()=>o(s),className:F("px-3 py-1 text-sm rounded transition-colors whitespace-nowrap",d===s?"bg-brand-500 text-white":"text-surface-400 hover:text-surface-200 hover:bg-surface-700"),children:u.name},u.name))}),e.jsxs("div",{className:"overflow-auto max-h-[500px]",children:[e.jsx("table",{className:"w-full text-sm",children:e.jsx("tbody",{children:m?.data.slice(0,100).map((u,s)=>e.jsx("tr",{className:s===0?"bg-surface-800 font-semibold":"",children:u.map((p,h)=>e.jsx("td",{className:"px-3 py-2 border border-surface-700 text-surface-300 whitespace-nowrap",children:p?.toString()||""},h))},s))})}),m?.data.length>100&&e.jsxs("p",{className:"text-center py-2 text-surface-500 text-sm",children:["Showing first 100 rows of ",m.data.length]})]})]})}function ne({evidenceId:a}){const[c,l]=r.useState(null),[d,o]=r.useState(!0),[x,f]=r.useState(null);return r.useEffect(()=>{(async()=>{try{const i=await fetch(`/api/evidence/${a}/preview`);if(!i.ok)throw new Error("Failed to load file");const m=await i.arrayBuffer(),s=await(await O(()=>import("./vendor-CWk44mA8.js").then(h=>h.i),__vite__mapDeps([0,1]))).convertToHtml({arrayBuffer:m}),p=te.sanitize(s.value,{ALLOWED_TAGS:["p","br","b","i","u","strong","em","h1","h2","h3","h4","h5","h6","ul","ol","li","table","thead","tbody","tr","th","td","a","span","div"],ALLOWED_ATTR:["href","class","style"],ALLOW_DATA_ATTR:!1});l(p)}catch(i){f(i.message)}finally{o(!1)}})()},[a]),d?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-surface-700 rounded-full border-t-brand-500"}),e.jsx("span",{className:"ml-2 text-surface-400",children:"Loading document..."})]}):x?e.jsx("div",{className:"text-center py-8 text-red-400",children:e.jsxs("p",{children:["Failed to load document: ",x]})}):e.jsx("div",{className:`p-6 prose prose-invert max-w-none overflow-auto max-h-[600px]
        prose-headings:text-surface-100 prose-p:text-surface-300 
        prose-strong:text-surface-200 prose-a:text-brand-400
        prose-ul:text-surface-300 prose-ol:text-surface-300
        prose-table:border-surface-700 prose-td:border-surface-700 prose-th:border-surface-700`,dangerouslySetInnerHTML:{__html:c||""}})}export{fe as default};
