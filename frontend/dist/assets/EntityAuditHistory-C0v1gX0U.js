import{r as S,b as D,j as e,B as p,ay as h,aa as g,a3 as I,az as k,aM as E,S as N,w,h as L,aA as T,N as O,aB as _,aC as $,V as B,am as V}from"./vendor-CWk44mA8.js";import{z as P}from"./index-CiJwl-Bo.js";import{a as F,f as z}from"./vendor-date-CWdg4M78.js";const v={created:_,uploaded:O,updated:T,deleted:L,linked:w,unlinked:w,reviewed:N,approved:N,rejected:E,synced:h,viewed:k,cloned:I,status_changed:h,default:g},y={created:{text:"text-emerald-400",bg:"bg-emerald-500/10",border:"border-emerald-500/30"},uploaded:{text:"text-cyan-400",bg:"bg-cyan-500/10",border:"border-cyan-500/30"},updated:{text:"text-blue-400",bg:"bg-blue-500/10",border:"border-blue-500/30"},deleted:{text:"text-red-400",bg:"bg-red-500/10",border:"border-red-500/30"},linked:{text:"text-purple-400",bg:"bg-purple-500/10",border:"border-purple-500/30"},unlinked:{text:"text-orange-400",bg:"bg-orange-500/10",border:"border-orange-500/30"},reviewed:{text:"text-teal-400",bg:"bg-teal-500/10",border:"border-teal-500/30"},approved:{text:"text-emerald-400",bg:"bg-emerald-500/10",border:"border-emerald-500/30"},rejected:{text:"text-red-400",bg:"bg-red-500/10",border:"border-red-500/30"},synced:{text:"text-indigo-400",bg:"bg-indigo-500/10",border:"border-indigo-500/30"},viewed:{text:"text-surface-400",bg:"bg-surface-500/10",border:"border-surface-500/30"},default:{text:"text-surface-400",bg:"bg-surface-500/10",border:"border-surface-500/30"}},b=["id","createdAt","updatedAt","deletedAt","organizationId","workspaceId","createdBy","updatedBy"],A={title:"Title",description:"Description",status:"Status",category:"Category",subcategory:"Subcategory",tags:"Tags",guidance:"Guidance",controlId:"Control ID",ownerId:"Owner",testingFrequency:"Testing Frequency",effectivenessScore:"Effectiveness Score",implementationNotes:"Implementation Notes",lastTestedAt:"Last Tested",nextTestDue:"Next Test Due",likelihood:"Likelihood",impact:"Impact",riskScore:"Risk Score",treatment:"Treatment",treatmentPlan:"Treatment Plan",residualLikelihood:"Residual Likelihood",residualImpact:"Residual Impact",residualScore:"Residual Score",priority:"Priority",dueDate:"Due Date",mimeType:"File Type",fileSize:"File Size",fileName:"File Name",version:"Version",approvedBy:"Approved By",approvedAt:"Approved At",reviewedBy:"Reviewed By",reviewedAt:"Reviewed At",automationSupported:"Automation Supported",isCustom:"Custom Control"};function f(t,r){if(t==null)return"—";if(typeof t=="boolean")return t?"Yes":"No";if(Array.isArray(t))return t.length===0?"—":t.join(", ");if(typeof t=="object")return JSON.stringify(t);if(r.includes("At")||r.includes("Date")||r.includes("Due"))try{const s=new Date(t);if(!isNaN(s.getTime()))return F(s,"MMM d, yyyy h:mm a")}catch{}return r==="status"?{not_started:"Not Started",in_progress:"In Progress",implemented:"Implemented",not_applicable:"Not Applicable",pending_review:"Pending Review",approved:"Approved",rejected:"Rejected",expired:"Expired",draft:"Draft",active:"Active",archived:"Archived"}[t]||t:String(t)}function R(t,r){if(!t&&!r)return[];const s=[],a=new Set([...Object.keys(t||{}),...Object.keys(r||{})]);for(const d of a){if(b.includes(d))continue;const n=t?.[d],c=r?.[d],m=JSON.stringify(n),u=JSON.stringify(c);m!==u&&s.push({field:d,oldValue:n,newValue:c})}return s}function M({changes:t}){const r=R(t.before,t.after);if(r.length===0){if(t.after&&!t.before){const s=Object.entries(t.after).filter(([a])=>!b.includes(a)&&t.after[a]!=null);return s.length===0?null:e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-surface-500 uppercase tracking-wide mb-2",children:"Initial Values"}),e.jsxs("div",{className:"space-y-1.5",children:[s.slice(0,10).map(([a,d])=>e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsxs("span",{className:"text-surface-400 min-w-[120px]",children:[A[a]||a,":"]}),e.jsx("span",{className:"text-emerald-400",children:f(d,a)})]},a)),s.length>10&&e.jsxs("p",{className:"text-xs text-surface-500 italic",children:["+ ",s.length-10," more fields"]})]})]})}return null}return e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-surface-500 uppercase tracking-wide mb-2",children:"Changes"}),e.jsx("div",{className:"space-y-2",children:r.map(({field:s,oldValue:a,newValue:d})=>e.jsxs("div",{className:"flex flex-col gap-1 p-2 rounded-lg bg-surface-800/50 border border-surface-700",children:[e.jsx("span",{className:"text-xs text-surface-400 font-medium",children:A[s]||s}),e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx("span",{className:"text-red-400 line-through opacity-75",children:f(a,s)}),e.jsx("span",{className:"text-surface-500",children:"→"}),e.jsx("span",{className:"text-emerald-400",children:f(d,s)})]})]},s))})]})}function q({entry:t}){const[r,s]=S.useState(!1),a=t.action.toLowerCase().replace(/\./g,"_"),d=v[a]||v.default,n=y[a]||y.default,c=t.changes,m=c?R(c.before,c.after):[],u=c?.after&&!c?.before&&Object.entries(c.after).filter(([o])=>!b.includes(o)&&c.after[o]!=null).length>0,x=m.length>0||u,l=t.timestamp||t.createdAt;return e.jsxs("div",{className:"relative pl-8 pb-6 last:pb-0",children:[e.jsx("div",{className:"absolute left-[11px] top-6 bottom-0 w-px bg-surface-700 last:hidden"}),e.jsx("div",{className:p("absolute left-0 w-6 h-6 rounded-full flex items-center justify-center",n.bg,"border",n.border),children:e.jsx(d,{className:p("w-3.5 h-3.5",n.text)})}),e.jsx("div",{className:p("bg-surface-800 rounded-lg border border-surface-700 overflow-hidden",x&&"cursor-pointer hover:border-surface-600 transition-colors"),onClick:()=>x&&s(!r),children:e.jsxs("div",{className:"p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:p("font-medium capitalize",n.text),children:a.replace(/_/g," ")}),t.entityName&&e.jsxs("span",{className:"text-surface-300 truncate",children:['"',t.entityName,'"']})]}),t.description&&e.jsx("p",{className:"text-sm text-surface-400 mt-1 line-clamp-2",children:t.description}),e.jsxs("div",{className:"flex items-center gap-3 mt-2 text-xs text-surface-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:t.userName||t.userEmail||"System"})]}),e.jsxs("div",{className:"flex items-center gap-1",title:F(new Date(l),"PPpp"),children:[e.jsx(g,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:z(new Date(l),{addSuffix:!0})})]})]})]}),x&&e.jsx("button",{className:"p-1 rounded hover:bg-surface-700 text-surface-400 hover:text-surface-200 transition-colors",onClick:o=>{o.stopPropagation(),s(!r)},children:r?e.jsx(B,{className:"w-4 h-4"}):e.jsx(V,{className:"w-4 h-4"})})]}),r&&x&&e.jsx(M,{changes:t.changes})]})})]})}function G({entityType:t,entityId:r,limit:s=50}){const[a,d]=S.useState("all"),{data:n,isLoading:c,error:m,refetch:u,isRefetching:x}=D({queryKey:["entity-audit",t,r,s],queryFn:()=>P.getByEntity(t,r,s).then(i=>i.data),enabled:!!t&&!!r}),l=Array.isArray(n)?n:n?.data||n?.logs||[],o=a==="all"?l:l.filter(i=>i.action.toLowerCase().includes(a)),j=[...new Set(l.map(i=>i.action.toLowerCase()))];return m?e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("p",{className:"text-red-400",children:"Failed to load history"}),e.jsx("button",{onClick:()=>u(),className:"mt-2 text-sm text-brand-400 hover:text-brand-300",children:"Try again"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Change History"}),l.length>0&&e.jsxs("span",{className:"text-xs text-surface-500 bg-surface-800 px-2 py-0.5 rounded-full",children:[l.length," ",l.length===1?"entry":"entries"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[j.length>1&&e.jsxs("select",{value:a,onChange:i=>d(i.target.value),className:"text-xs bg-surface-800 border border-surface-700 rounded-md text-surface-300 py-1.5 px-2",children:[e.jsx("option",{value:"all",children:"All Actions"}),j.map(i=>e.jsx("option",{value:i,children:i.replace(/_/g," ").replace(/\./g," ")},i))]}),e.jsx("button",{onClick:()=>u(),className:p("p-1.5 rounded-md hover:bg-surface-700 text-surface-400 hover:text-white transition-colors",x&&"animate-spin"),title:"Refresh",children:e.jsx(h,{className:"w-4 h-4"})})]})]}),c?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((i,C)=>e.jsxs("div",{className:"relative pl-8 pb-6",children:[e.jsx("div",{className:"absolute left-0 w-6 h-6 rounded-full bg-surface-700 animate-pulse"}),e.jsxs("div",{className:"bg-surface-800 rounded-lg border border-surface-700 p-4 animate-pulse",children:[e.jsx("div",{className:"h-4 bg-surface-700 rounded w-1/3 mb-2"}),e.jsx("div",{className:"h-3 bg-surface-700 rounded w-2/3"})]})]},C))}):o.length===0?e.jsxs("div",{className:"text-center py-12 bg-surface-800/50 rounded-lg border border-surface-700",children:[e.jsx(g,{className:"w-10 h-10 mx-auto text-surface-600 mb-3"}),e.jsx("p",{className:"text-surface-400",children:"No history recorded yet"}),e.jsx("p",{className:"text-surface-500 text-sm mt-1",children:"Changes will appear here as they are made"})]}):e.jsx("div",{className:"relative",children:o.map(i=>e.jsx(q,{entry:i},i.id))})]})}export{G as E};
