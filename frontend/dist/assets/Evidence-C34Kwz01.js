import{u as M,aK as _,r as x,b as L,c as q,j as e,w as R,L as Q,aO as O,aI as B,l as W,x as Y,y as U,aT as G,B as m,aJ as J,aD as u,aU as V,m as $,f as H}from"./vendor-CWk44mA8.js";import{b as X,n as Z,B as I,l as f,e as ee}from"./index-CiJwl-Bo.js";import{u as se}from"./useDebounce-BWtFJvQ9.js";import{d as ae}from"./Skeleton-DVOICtGK.js";import"./vendor-http-B9ygI19o.js";import"./vendor-date-CWdg4M78.js";const A={screenshot:G,document:U,default:U},te={pending_review:"badge-warning",approved:"badge-success",rejected:"badge-danger",expired:"badge-neutral"};function ue(){const{hasPermission:l}=X(),n=M(),[c]=_(),[r,N]=x.useState(""),o=se(r,300),[i,y]=x.useState(""),[E,v]=x.useState(!1),w=Z(),t=c.get("controlId"),{data:j,isLoading:F}=L({queryKey:["evidence",o,i,w],queryFn:()=>f.list({search:o||void 0,type:i?[i]:void 0,workspaceId:w||void 0,limit:25}).then(s=>s.data),staleTime:30*1e3}),{data:h}=L({queryKey:["evidence-stats"],queryFn:()=>f.getStats().then(s=>s.data)}),{data:d}=L({queryKey:["control",t],queryFn:()=>ee.get(t).then(s=>s.data),enabled:!!t}),a=q({mutationFn:({evidenceId:s,controlId:p})=>f.link(s,[p]),onSuccess:()=>{n.invalidateQueries({queryKey:["evidence"]}),n.invalidateQueries({queryKey:["control",t]}),n.invalidateQueries({queryKey:["controls"]}),u.success("Evidence linked to control")},onError:()=>{u.error("Failed to link evidence")}}),k=q({mutationFn:({evidenceId:s,controlId:p})=>f.unlink(s,p),onSuccess:()=>{n.invalidateQueries({queryKey:["evidence"]}),n.invalidateQueries({queryKey:["control",t]}),n.invalidateQueries({queryKey:["controls"]}),u.success("Evidence unlinked from control")},onError:()=>{u.error("Failed to unlink evidence")}}),K=Array.isArray(j)?j:j?.data||[],z=s=>t?s.controlLinks?.some(p=>p.controlId===t):!1;return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[t&&d&&e.jsx("div",{className:"card p-4 border-brand-500 bg-brand-500/10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(R,{className:"w-5 h-5 text-brand-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-surface-100",children:"Linking evidence to control"}),e.jsxs("p",{className:"text-xs text-surface-400",children:[e.jsx("span",{className:"font-mono text-brand-400",children:d.controlId})," - ",d.title]})]})]}),e.jsxs(Q,{to:`/controls/${t}`,className:"btn-outline text-sm",children:[e.jsx(O,{className:"w-4 h-4 mr-1"}),"Back to Control"]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-surface-100",children:"Evidence Library"}),e.jsx("p",{className:"text-surface-400 mt-1",children:t?"Select evidence to link to the control, or upload new evidence":"Manage evidence files and link them to controls"})]}),l("evidence:upload")&&e.jsx(I,{onClick:()=>v(!0),leftIcon:e.jsx(B,{className:"w-4 h-4"}),children:"Upload Evidence"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(C,{label:"Total",value:h?.total||0}),e.jsx(C,{label:"Pending Review",value:h?.pendingReview||0,color:"yellow"}),e.jsx(C,{label:"Expiring Soon",value:h?.expiringSoon||0,color:"orange"}),e.jsx(C,{label:"Expired",value:h?.expired||0,color:"red"})]}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-surface-500"}),e.jsx("input",{type:"text",placeholder:"Search evidence...",value:r,onChange:s=>N(s.target.value),className:"input pl-10"})]}),e.jsxs("select",{value:i,onChange:s=>y(s.target.value),className:"input w-full md:w-48",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"screenshot",children:"Screenshots"}),e.jsx("option",{value:"document",children:"Documents"}),e.jsx("option",{value:"export",children:"Exports"}),e.jsx("option",{value:"report",children:"Reports"}),e.jsx("option",{value:"configuration",children:"Configurations"}),e.jsx("option",{value:"log",children:"Logs"})]})]})}),F?e.jsx(ae,{count:9}):K.length===0?e.jsxs("div",{className:"card flex flex-col items-center justify-center py-16 text-surface-500",children:[e.jsx(Y,{className:"w-16 h-16 mb-4"}),e.jsx("p",{className:"text-lg mb-2",children:"No evidence found"}),e.jsx("p",{className:"text-sm",children:"Upload your first evidence file to get started"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:K.map(s=>{const p=A[s.type]||A.default,S=z(s);return e.jsxs(Q,{to:`/evidence/${s.id}`,className:m("card p-4 transition-colors block",S?"border-green-500/50 bg-green-500/5":"hover:border-surface-700"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-surface-800 rounded-lg",children:e.jsx(p,{className:"w-6 h-6 text-surface-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-sm font-medium text-surface-100 truncate",children:s.title}),e.jsx("p",{className:"text-xs text-surface-500 mt-1",children:s.filename}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:m("badge text-xs",te[s.status]),children:s.status.replace("_"," ")}),e.jsx("span",{className:"text-xs text-surface-500 capitalize",children:s.type})]}),s.controlLinks?.length>0&&e.jsxs("p",{className:"text-xs text-surface-500 mt-2",children:["Linked to ",s.controlLinks.length," control(s)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-4 pt-3 border-t border-surface-800",children:[e.jsx("span",{className:"text-xs text-surface-500 flex-1",children:new Date(s.createdAt).toLocaleDateString()}),t&&e.jsxs("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),S?k.mutate({evidenceId:s.id,controlId:t}):a.mutate({evidenceId:s.id,controlId:t})},disabled:a.isPending||k.isPending,className:m("px-2 py-1 text-xs rounded-md transition-colors flex items-center gap-1",S?"bg-green-500/20 text-green-400 hover:bg-red-500/20 hover:text-red-400":"bg-brand-500/20 text-brand-400 hover:bg-brand-500/30"),children:[e.jsx(R,{className:"w-3 h-3"}),S?"Linked âœ“":"Link"]}),e.jsx("button",{onClick:async g=>{g.preventDefault(),g.stopPropagation();try{const P=await f.getDownloadUrl(s.id),D=P.data?.url||P.data,T=typeof D=="string"?D:D?.url||"";if(T){const b=document.createElement("a");b.href=T,b.download=s.filename||"evidence-file",document.body.appendChild(b),b.click(),document.body.removeChild(b)}else u.error("Download URL not available")}catch{u.error("Failed to download file")}},className:"p-1 text-surface-400 hover:text-surface-100",title:"Download",children:e.jsx(J,{className:"w-4 h-4"})})]})]},s.id)})}),E&&e.jsx(ne,{onClose:()=>v(!1),linkToControlId:t})]})}function C({label:l,value:n,color:c="surface"}){const r={surface:"text-surface-100",yellow:"text-yellow-400",orange:"text-orange-400",red:"text-red-400"};return e.jsxs("div",{className:"card p-4",children:[e.jsx("p",{className:"text-sm text-surface-400",children:l}),e.jsx("p",{className:m("text-2xl font-bold mt-1",r[c]),children:n})]})}function ne({onClose:l,linkToControlId:n}){const c=M(),[r,N]=x.useState(null),[o,i]=x.useState(""),[y,E]=x.useState("document"),[v,w]=x.useState(""),t=q({mutationFn:async()=>{if(!r)throw new Error("No file selected");const a={title:o,type:y,description:v};return n&&(a.controlIds=[n]),f.upload(r,a)},onSuccess:()=>{c.invalidateQueries({queryKey:["evidence"]}),c.invalidateQueries({queryKey:["evidence-stats"]}),n&&(c.invalidateQueries({queryKey:["control",n]}),c.invalidateQueries({queryKey:["controls"]})),u.success(n?"Evidence uploaded and linked to control":"Evidence uploaded successfully"),l()},onError:a=>{console.error("Upload error:",a);const k=a?.response?.data?.message||a?.message||"Failed to upload evidence";u.error(k)}}),j=x.useCallback(a=>{a[0]&&(N(a[0]),o||i(a[0].name.replace(/\.[^/.]+$/,"")))},[o]),{getRootProps:F,getInputProps:h,isDragActive:d}=V({onDrop:j,maxFiles:1,accept:{"application/pdf":[".pdf"],"image/*":[".png",".jpg",".jpeg",".gif"],"application/msword":[".doc"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"],"text/csv":[".csv"],"text/plain":[".txt"]}});return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black/60",onClick:l}),e.jsx("div",{className:"relative min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-surface-900 border border-surface-800 rounded-xl w-full max-w-lg p-6 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-surface-100",children:"Upload Evidence"}),e.jsx("button",{onClick:l,className:"text-surface-400 hover:text-surface-100",children:e.jsx($,{className:"w-5 h-5"})})]}),n&&e.jsx("div",{className:"mb-4 p-3 bg-brand-500/10 border border-brand-500/30 rounded-lg text-sm",children:e.jsxs("div",{className:"flex items-center gap-2 text-brand-400",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"This evidence will be linked to the control automatically"})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{...F(),className:m("border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-all",d?"border-brand-500 bg-brand-500/10 scale-[1.02]":r?"border-green-500 bg-green-500/10":"border-surface-700 hover:border-surface-600"),children:[e.jsx("input",{...h()}),r?e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-400",children:[e.jsx(H,{className:"w-6 h-6"}),e.jsx("span",{className:"truncate max-w-xs",children:r.name}),e.jsx("button",{type:"button",onClick:a=>{a.stopPropagation(),N(null),i("")},className:"ml-2 p-1 hover:bg-surface-700 rounded",children:e.jsx($,{className:"w-4 h-4 text-surface-400"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:m("w-12 h-12 mx-auto mb-4 transition-colors",d?"text-brand-400":"text-surface-500")}),e.jsx("p",{className:m("transition-colors",d?"text-brand-300":"text-surface-300"),children:d?"Drop the file here...":"Drag and drop a file here, or click to select"}),e.jsx("p",{className:"text-surface-500 text-sm mt-2",children:"PDF, Word, Excel, Images, CSV, Text"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Title"}),e.jsx("input",{type:"text",value:o,onChange:a=>i(a.target.value),className:"input mt-1",placeholder:"Evidence title"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Type"}),e.jsxs("select",{value:y,onChange:a=>E(a.target.value),className:"input mt-1",children:[e.jsx("option",{value:"document",children:"Document"}),e.jsx("option",{value:"screenshot",children:"Screenshot"}),e.jsx("option",{value:"export",children:"Export"}),e.jsx("option",{value:"report",children:"Report"}),e.jsx("option",{value:"configuration",children:"Configuration"}),e.jsx("option",{value:"log",children:"Log"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Description (optional)"}),e.jsx("textarea",{value:v,onChange:a=>w(a.target.value),className:"input mt-1",rows:3,placeholder:"Brief description of this evidence"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx(I,{variant:"secondary",onClick:l,children:"Cancel"}),e.jsx(I,{onClick:()=>t.mutate(),disabled:!r||!o,isLoading:t.isPending,children:"Upload"})]})]})})]})}export{ue as default};
