import{aK as w,u as R,r as m,b as f,c as C,j as e,M as S,aa as h,aM as F,S as P,a7 as p,B as T,aP as k}from"./vendor-CWk44mA8.js";import{B as o}from"./index-CiJwl-Bo.js";import{u as E}from"./useToast-oJzujiun.js";import"./vendor-http-B9ygI19o.js";import"./vendor-date-CWdg4M78.js";const I={effective:{icon:P,color:"text-green-400",label:"Effective"},partially_effective:{icon:h,color:"text-yellow-400",label:"Partially Effective"},ineffective:{icon:F,color:"text-red-400",label:"Ineffective"},not_applicable:{icon:h,color:"text-surface-400",label:"N/A"}},q={inquiry:"Inquiry",observation:"Observation",inspection:"Inspection",reperformance:"Reperformance"};function Q(){const[j]=w(),c=j.get("auditId")||"",u=R(),b=E(),[v,d]=m.useState(null),[a,l]=m.useState({actualResult:"",deviationsNoted:"",conclusion:"effective",conclusionRationale:""}),{data:x=[],isLoading:g}=f({queryKey:["test-procedures",c],queryFn:async()=>{const s=new URLSearchParams;c&&s.set("auditId",c);const t=await fetch(`/api/audit/test-procedures?${s}`);if(!t.ok)throw new Error("Failed to fetch procedures");return t.json()}}),{data:n}=f({queryKey:["test-procedures-stats",c],queryFn:async()=>{const s=new URLSearchParams;c&&s.set("auditId",c);const t=await fetch(`/api/audit/test-procedures/stats?${s}`);if(!t.ok)throw new Error("Failed to fetch stats");return t.json()}}),N=C({mutationFn:async({id:s,data:t})=>{const i=await fetch(`/api/audit/test-procedures/${s}/record-result`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw new Error("Failed to record result");return i.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["test-procedures"]}),u.invalidateQueries({queryKey:["test-procedures-stats"]}),b.success("Test result recorded"),d(null),l({actualResult:"",deviationsNoted:"",conclusion:"effective",conclusionRationale:""})}}),y=s=>{N.mutate({id:s,data:a})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Test Procedures"}),e.jsx("p",{className:"text-surface-400 mt-1",children:"Control testing with sampling and effectiveness assessment"})]}),e.jsxs(o,{children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"New Procedure"]})]}),n&&e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Total Procedures"}),e.jsx("p",{className:"text-3xl font-bold text-white",children:n.total})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Effectiveness Rate"}),e.jsxs("p",{className:"text-3xl font-bold text-green-400",children:[n.effectivenessRate,"%"]})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Completed"}),e.jsx("p",{className:"text-3xl font-bold text-white",children:n.byStatus.find(s=>s.status==="completed")?.count||0})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 border border-surface-700",children:[e.jsx("p",{className:"text-surface-400 text-sm",children:"Pending"}),e.jsx("p",{className:"text-3xl font-bold text-yellow-400",children:n.byStatus.find(s=>s.status==="pending")?.count||0})]})]}),g?e.jsx("div",{className:"animate-pulse space-y-4",children:[1,2,3].map(s=>e.jsx("div",{className:"bg-surface-800 rounded-lg h-24"},s))}):e.jsxs("div",{className:"space-y-4",children:[x.map(s=>{const t=s.conclusion?I[s.conclusion]:null,i=v===s.id;return e.jsxs("div",{className:"bg-surface-800 rounded-lg border border-surface-700 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-2 bg-brand-500/10 rounded-lg",children:e.jsx(p,{className:"h-6 w-6 text-brand-400"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-sm text-brand-400",children:s.procedureNumber}),e.jsx("h3",{className:"font-semibold text-white",children:s.title})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-surface-400",children:[e.jsx("span",{children:q[s.testType]||s.testType}),s.sampleSize&&e.jsxs("span",{children:["Sample: ",s.sampleSize]}),s.testedByUser&&e.jsxs("span",{children:["Tested by: ",s.testedByUser.displayName]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[s.conclusion&&t&&e.jsxs("span",{className:T("flex items-center gap-1",t.color),children:[e.jsx(t.icon,{className:"h-4 w-4"}),t.label]}),s.status==="pending"&&!i&&e.jsxs(o,{variant:"secondary",size:"sm",onClick:()=>d(s.id),children:[e.jsx(k,{className:"h-4 w-4 mr-1"}),"Record Result"]})]})]}),i&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-surface-700",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-400 mb-1",children:"Actual Result"}),e.jsx("textarea",{value:a.actualResult,onChange:r=>l({...a,actualResult:r.target.value}),className:"w-full bg-surface-900 border border-surface-600 rounded-lg px-3 py-2 text-white",rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-400 mb-1",children:"Deviations Noted"}),e.jsx("textarea",{value:a.deviationsNoted,onChange:r=>l({...a,deviationsNoted:r.target.value}),className:"w-full bg-surface-900 border border-surface-600 rounded-lg px-3 py-2 text-white",rows:3})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-400 mb-1",children:"Conclusion"}),e.jsxs("select",{value:a.conclusion,onChange:r=>l({...a,conclusion:r.target.value}),className:"w-full bg-surface-900 border border-surface-600 rounded-lg px-3 py-2 text-white",children:[e.jsx("option",{value:"effective",children:"Effective"}),e.jsx("option",{value:"partially_effective",children:"Partially Effective"}),e.jsx("option",{value:"ineffective",children:"Ineffective"}),e.jsx("option",{value:"not_applicable",children:"Not Applicable"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-400 mb-1",children:"Conclusion Rationale"}),e.jsx("input",{type:"text",value:a.conclusionRationale,onChange:r=>l({...a,conclusionRationale:r.target.value}),className:"w-full bg-surface-900 border border-surface-600 rounded-lg px-3 py-2 text-white"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(o,{variant:"ghost",onClick:()=>d(null),children:"Cancel"}),e.jsx(o,{onClick:()=>y(s.id),children:"Save Result"})]})]})]},s.id)}),x.length===0&&e.jsxs("div",{className:"text-center py-12 bg-surface-800 rounded-lg border border-surface-700",children:[e.jsx(p,{className:"h-12 w-12 text-surface-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-white",children:"No test procedures yet"}),e.jsx("p",{className:"text-surface-400 mt-2",children:"Create test procedures to document control testing."})]})]})]})}export{Q as default};
