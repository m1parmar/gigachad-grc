import{u as z,r as l,c as B,j as e,m as G,S as W,v as H,B as R,y as X,aI as K,aJ as Y,aK as Z,W as ee,k as se,b as O,N as te,M as ae,l as re,aL as le,aM as ne,aN as oe,aa as ce,L as Q,aD as T,h as de}from"./vendor-CWk44mA8.js";import{e as v,B as J,f as ie}from"./index-CiJwl-Bo.js";import{u as ue}from"./useDebounce-BWtFJvQ9.js";import{u as xe,A as me,c as he}from"./AdvancedFilters-BfP-VL-m.js";import{a as pe}from"./Skeleton-DVOICtGK.js";import{E as fe}from"./ExportDropdown-ClBGGM80.js";import{e as ge}from"./export-DqfI3kh9.js";import{u as be,B as je,S as ve,a as V}from"./BulkActions-DgJpXIcY.js";import"./vendor-http-B9ygI19o.js";import"./vendor-date-CWdg4M78.js";import"./Modal-BXiMOSLX.js";function Ne({isOpen:d,onClose:F}){const U=z(),D=l.useRef(null),[N,y]=l.useState("csv"),[i,w]=l.useState(""),[k,I]=l.useState(""),[S,f]=l.useState(!0),[p,C]=l.useState(!1),[r,_]=l.useState(null),[g,u]=l.useState(!1),x=B({mutationFn:async t=>{if(t.mode==="csv")return(await v.bulkUploadCSV({csv:t.content,skipExisting:S,updateExisting:p})).data;{const c=JSON.parse(t.content);return(await v.bulkUpload({controls:Array.isArray(c)?c:c.controls,skipExisting:S,updateExisting:p})).data}},onSuccess:t=>{_(t),U.invalidateQueries({queryKey:["controls"]})}}),m=l.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?u(!0):t.type==="dragleave"&&u(!1)},[]),E=l.useCallback(t=>{t.preventDefault(),t.stopPropagation(),u(!1),t.dataTransfer.files&&t.dataTransfer.files[0]&&$(t.dataTransfer.files[0])},[]),$=t=>{I(t.name),t.name.endsWith(".json")?y("json"):y("csv");const c=new FileReader;c.onload=j=>{w(j.target?.result)},c.readAsText(t)},L=t=>{t.target.files&&t.target.files[0]&&$(t.target.files[0])},h=()=>{i&&x.mutate({content:i,mode:N})},a=async()=>{try{const t=await v.getTemplate(),c=new Blob([t.data],{type:"text/csv"}),j=window.URL.createObjectURL(c),A=document.createElement("a");A.href=j,A.download="controls-template.csv",A.click(),window.URL.revokeObjectURL(j)}catch(t){console.error("Failed to download template:",t)}},b=()=>{w(""),I(""),_(null),x.reset(),F()};return d?e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm",onClick:b}),e.jsxs("div",{className:"relative w-full max-w-2xl bg-surface-900 rounded-xl shadow-2xl border border-surface-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-surface-700",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-surface-100",children:"Bulk Upload Controls"}),e.jsx("p",{className:"text-sm text-surface-400 mt-1",children:"Import controls from CSV or JSON file"})]}),e.jsx("button",{onClick:b,className:"p-2 text-surface-400 hover:text-surface-200 hover:bg-surface-800 rounded-lg transition-colors",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6 space-y-6",children:r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[r.errors?.length?e.jsx(H,{className:"w-8 h-8 text-yellow-400"}):e.jsx(W,{className:"w-8 h-8 text-green-400"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-surface-100",children:"Upload Complete"}),e.jsxs("p",{className:"text-surface-400",children:["Processed ",r.total||r.created+r.updated+r.skipped," controls"]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-400",children:r.created}),e.jsx("div",{className:"text-sm text-surface-400",children:"Created"})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:r.updated}),e.jsx("div",{className:"text-sm text-surface-400",children:"Updated"})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-surface-400",children:r.skipped}),e.jsx("div",{className:"text-sm text-surface-400",children:"Skipped"})]}),e.jsxs("div",{className:"bg-surface-800 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:r.errors?.length||0}),e.jsx("div",{className:"text-sm text-surface-400",children:"Errors"})]})]}),(r.errors?.length??0)>0&&e.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-red-400 mb-2",children:"Errors"}),e.jsx("div",{className:"max-h-40 overflow-y-auto space-y-1",children:r.errors?.map((t,c)=>e.jsxs("div",{className:"text-sm text-surface-300",children:[e.jsxs("span",{className:"font-mono text-red-400",children:["Row ",t.row||"?"," (",t.controlId,"):"]})," ",t.error]},c))})]}),e.jsx("button",{onClick:b,className:"btn-primary w-full",children:"Done"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>y("csv"),className:R("flex-1 py-2 px-4 rounded-lg border transition-colors",N==="csv"?"bg-brand-600 border-brand-500 text-white":"bg-surface-800 border-surface-700 text-surface-300 hover:border-surface-600"),children:"CSV Format"}),e.jsx("button",{onClick:()=>y("json"),className:R("flex-1 py-2 px-4 rounded-lg border transition-colors",N==="json"?"bg-brand-600 border-brand-500 text-white":"bg-surface-800 border-surface-700 text-surface-300 hover:border-surface-600"),children:"JSON Format"})]}),e.jsxs("div",{className:R("relative border-2 border-dashed rounded-xl p-8 text-center transition-colors",g?"border-brand-500 bg-brand-500/10":i?"border-green-500 bg-green-500/10":"border-surface-700 hover:border-surface-600"),onDragEnter:m,onDragLeave:m,onDragOver:m,onDrop:E,children:[e.jsx("input",{ref:D,type:"file",accept:".csv,.json",onChange:L,className:"hidden"}),i?e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"w-12 h-12 mx-auto text-green-400"}),e.jsx("p",{className:"text-surface-100 font-medium",children:k}),e.jsxs("p",{className:"text-surface-400 text-sm",children:[i.split(`
`).length," lines loaded"]}),e.jsx("button",{onClick:()=>{w(""),I("")},className:"text-sm text-brand-400 hover:text-brand-300",children:"Choose different file"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"w-12 h-12 mx-auto text-surface-500"}),e.jsxs("p",{className:"text-surface-300",children:["Drag and drop your file here, or"," ",e.jsx("button",{onClick:()=>D.current?.click(),className:"text-brand-400 hover:text-brand-300",children:"browse"})]}),e.jsx("p",{className:"text-surface-500 text-sm",children:"Supports .csv and .json files"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:t=>{f(t.target.checked),t.target.checked&&C(!1)},className:"w-4 h-4 rounded border-surface-600 bg-surface-800 text-brand-500 focus:ring-brand-500"}),e.jsx("span",{className:"text-surface-300",children:"Skip existing controls"})]}),e.jsxs("label",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:t=>{C(t.target.checked),t.target.checked&&f(!1)},className:"w-4 h-4 rounded border-surface-600 bg-surface-800 text-brand-500 focus:ring-brand-500"}),e.jsx("span",{className:"text-surface-300",children:"Update existing controls"})]})]}),e.jsx("div",{className:"bg-surface-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-surface-200",children:"Need a template?"}),e.jsx("p",{className:"text-sm text-surface-400",children:"Download our CSV template with example data"})]}),e.jsxs("button",{onClick:a,className:"btn-secondary text-sm",children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Download"]})]})}),x.isError&&e.jsx("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-4",children:e.jsx("p",{className:"text-red-400",children:x.error?.response?.data?.message||x.error?.message||"Upload failed"})})]})}),!r&&e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-surface-700",children:[e.jsx("button",{onClick:b,className:"btn-secondary",children:"Cancel"}),e.jsx("button",{onClick:h,disabled:!i||x.isPending,className:"btn-primary disabled:opacity-50 disabled:cursor-not-allowed",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white/30 rounded-full border-t-white mr-2"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-4 h-4 mr-2"}),"Upload Controls"]})})]})]})]})}):null}const ye=[{key:"title",label:"Title",type:"string"},{key:"controlId",label:"Control ID",type:"string"},{key:"category",label:"Category",type:"select",options:[{value:"access_control",label:"Access Control"},{value:"data_protection",label:"Data Protection"},{value:"network_security",label:"Network Security"},{value:"physical_security",label:"Physical Security"},{value:"incident_response",label:"Incident Response"},{value:"business_continuity",label:"Business Continuity"},{value:"compliance",label:"Compliance"},{value:"risk_management",label:"Risk Management"}]},{key:"status",label:"Status",type:"select",options:[{value:"implemented",label:"Implemented"},{value:"in_progress",label:"In Progress"},{value:"not_started",label:"Not Started"},{value:"not_applicable",label:"N/A"}]},{key:"owner",label:"Owner",type:"string"}],we={implemented:{label:"Implemented",icon:W,color:"text-green-400 bg-green-400/10"},in_progress:{label:"In Progress",icon:ce,color:"text-yellow-400 bg-yellow-400/10"},not_started:{label:"Not Started",icon:oe,color:"text-surface-400 bg-surface-400/10"},not_applicable:{label:"N/A",icon:ne,color:"text-blue-400 bg-blue-400/10"}},ke=[{value:"implemented",label:"Implemented",color:"bg-green-500"},{value:"in_progress",label:"In Progress",color:"bg-yellow-500"},{value:"not_started",label:"Not Started",color:"bg-surface-500"},{value:"not_applicable",label:"N/A",color:"bg-blue-500"}];function $e(){const[d,F]=Z(),U=ee(),D=se(),N=z(),[y,i]=l.useState(!1),[w,k]=l.useState(!1),{prefetchControl:I}=xe(),S=U.pathname+U.search,f=d.get("category")||"",p=d.get("status")||"",C=d.get("framework")||"",[r,_]=l.useState(d.get("search")||""),g=ue(r,300),u=l.useCallback((s,n)=>{const o=new URLSearchParams(d);n?o.set(s,n):o.delete(s),F(o,{replace:!0})},[d,F]),x=l.useCallback(s=>{_(s)},[]);l.useEffect(()=>{const s=d.get("search")||"";g!==s&&u("search",g)},[g,u,d]);const{data:m,isLoading:E}=O({queryKey:["controls",g,f,p,C],queryFn:()=>v.list({search:g||void 0,category:f?[f]:void 0,status:p?[p]:void 0,frameworkId:C||void 0,limit:25}).then(s=>s.data),staleTime:30*1e3}),{data:$}=O({queryKey:["control-categories"],queryFn:()=>v.getCategories().then(s=>s.data)}),{data:L}=O({queryKey:["frameworks"],queryFn:()=>ie.list().then(s=>s.data)}),h=m?.data||[],a=be(h),b=B({mutationFn:async s=>(await Promise.all(s.map(n=>v.delete(n))),s.length),onSuccess:s=>{N.invalidateQueries({queryKey:["controls"]}),a.clearSelection(),T.success(`Deleted ${s} control${s>1?"s":""}`)},onError:()=>{T.error("Failed to delete some controls")}}),t=B({mutationFn:async({ids:s,status:n})=>(await Promise.all(s.map(o=>v.update(o,{implementation:{status:n}}))),s.length),onSuccess:s=>{N.invalidateQueries({queryKey:["controls"]}),a.clearSelection(),T.success(`Updated ${s} control${s>1?"s":""}`)},onError:()=>{T.error("Failed to update some controls")}}),c=async s=>{const n=Array.from(a.selectedIds);if(s==="delete"){k(!0);try{await b.mutateAsync(n)}finally{k(!1)}}},j=async s=>{const n=Array.from(a.selectedIds);k(!0);try{await t.mutateAsync({ids:n,status:s})}finally{k(!1)}},A=[{id:"delete",label:"Delete",icon:e.jsx(de,{className:"w-4 h-4"}),variant:"danger",requiresConfirmation:!0,confirmMessage:`Are you sure you want to delete ${a.count} control${a.count>1?"s":""}? This action cannot be undone.`}];return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx(je,{selectedCount:a.count,totalCount:h.length,onClear:a.clearSelection,actions:A,onAction:c,isProcessing:w,processingLabel:b.isPending?"Deleting...":"Processing..."}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-surface-100",children:"Controls"}),e.jsx("p",{className:"text-surface-400 mt-1",children:"Manage your security controls and track implementation status"})]}),e.jsxs("div",{className:"flex gap-3",children:[a.count>0&&e.jsx(ve,{options:ke,onSelect:j,disabled:w,buttonText:"Update Status"}),e.jsx(me,{fields:ye,onApply:s=>{const n=he(s),o=new URLSearchParams(d);o.delete("category"),o.delete("status"),Object.entries(n).forEach(([M,P])=>{P&&o.set(M,P)}),F(o,{replace:!0})},storageKey:"controls"}),e.jsx(fe,{data:a.count>0?a.selectedItems:h,columns:ge.controls,filename:"controls",sheetName:"Controls",disabled:E||h.length===0,buttonText:a.count>0?`Export (${a.count})`:"Export"}),e.jsx(J,{variant:"secondary",onClick:()=>i(!0),leftIcon:e.jsx(te,{className:"w-4 h-4"}),children:"Bulk Upload"}),e.jsx(J,{onClick:()=>D("/controls/new"),leftIcon:e.jsx(ae,{className:"w-4 h-4"}),children:"Add Control"})]})]}),e.jsx(Ne,{isOpen:y,onClose:()=>i(!1)}),e.jsx("div",{className:"card p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(re,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-surface-500"}),e.jsx("input",{type:"text",placeholder:"Search controls...",value:r,onChange:s=>x(s.target.value),className:"input pl-10"})]}),e.jsxs("select",{value:f,onChange:s=>u("category",s.target.value),className:"input w-full md:w-48",children:[e.jsx("option",{value:"",children:"All Categories"}),$?.map(s=>e.jsxs("option",{value:s.category,children:[s.category.replace("_"," ")," (",s.count,")"]},s.category))]}),e.jsxs("select",{value:p,onChange:s=>u("status",s.target.value),className:"input w-full md:w-40",children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"implemented",children:"Implemented"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"not_started",children:"Not Started"}),e.jsx("option",{value:"not_applicable",children:"N/A"})]}),e.jsxs("select",{value:C,onChange:s=>u("framework",s.target.value),className:"input w-full md:w-48",children:[e.jsx("option",{value:"",children:"All Frameworks"}),L?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})}),e.jsx("div",{className:"card overflow-hidden",children:E?e.jsx(pe,{rows:10,columns:7,className:"border-none shadow-none"}):h.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-surface-500",children:[e.jsx(le,{className:"w-12 h-12 mb-4"}),e.jsx("p",{children:"No controls found"})]}):e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"w-12",children:e.jsx(V,{checked:a.isAllSelected,indeterminate:a.isPartialSelected,onChange:a.toggleAll})}),e.jsx("th",{children:"Control ID"}),e.jsx("th",{children:"Title"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Evidence"}),e.jsx("th",{children:"Frameworks"})]})}),e.jsx("tbody",{children:h.map(s=>{const n=s.status||s.implementation?.status||"not_started",o=we[n],M=o.icon,P=a.isSelected(s.id);return e.jsxs("tr",{className:R(P&&"bg-brand-500/10"),onMouseEnter:()=>I(s.id),children:[e.jsx("td",{children:e.jsx(V,{checked:P,onChange:()=>a.toggle(s.id)})}),e.jsx("td",{children:e.jsx(Q,{to:`/controls/${s.id}`,state:{from:S},className:"font-mono text-brand-400 hover:text-brand-300",children:s.controlId})}),e.jsx("td",{children:e.jsx(Q,{to:`/controls/${s.id}`,state:{from:S},className:"text-surface-100 hover:text-brand-400",children:s.title})}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-neutral capitalize",children:s.category.replace("_"," ")})}),e.jsx("td",{children:e.jsxs("div",{className:R("badge",o.color),children:[e.jsx(M,{className:"w-3 h-3 mr-1"}),o.label]})}),e.jsx("td",{children:e.jsx("span",{className:"text-surface-400",children:s.evidenceCount||0})}),e.jsx("td",{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.frameworkMappings?.slice(0,2).map(q=>e.jsx("span",{className:"badge badge-info text-xs",children:q.frameworkName},q.frameworkId)),s.frameworkMappings?.length>2&&e.jsxs("span",{className:"badge badge-neutral text-xs",children:["+",s.frameworkMappings.length-2]})]})})]},s.id)})})]})})}),m?.meta&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-surface-500",children:[e.jsxs("span",{children:["Showing ",h.length," of ",m.meta.total," controls"]}),e.jsxs("span",{children:["Page ",m.meta.page," of ",m.meta.totalPages]})]})]})}export{$e as default};
